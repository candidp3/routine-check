<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸˆë£¨í‹´ ì²´í¬</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#222222">

<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f6f6f6;margin:0;padding:14px;color:#222}
h1{text-align:center;margin:6px 0}
.small{font-size:13px;color:#666}
.tabs,.modes{display:flex;gap:8px;margin:12px 0}
.tab,.mode{flex:1;padding:10px;border-radius:12px;border:none;background:#e6e6e6;font-size:14px}
.tab.active,.mode.on{background:#cfcfcf;font-weight:700}
.section{background:#fff;border-radius:14px;padding:12px;margin-bottom:10px}
.section h2{margin:0 0 8px;font-size:16px}
label{display:flex;align-items:center;gap:8px;padding:6px 0}
input[type=checkbox]{width:18px;height:18px}
.result{text-align:center;font-size:20px;font-weight:800;margin:14px 0}
.pass{color:#2e7d32}.mid{color:#f9a825}.rest{color:#c62828}
.btn{width:100%;padding:10px;border-radius:12px;border:none;background:#e6e6e6;font-size:14px}
.btn:active{background:#cfcfcf}
.hide{display:none}

table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eee;font-size:13px}
th{text-align:left;color:#666}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
.ok{background:#e7f6ea;color:#2e7d32}
.midb{background:#fff4d6;color:#f9a825}
.restb{background:#fde7e7;color:#c62828}

.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,.textin{
  padding:8px 10px;border-radius:10px;border:1px solid #ddd;background:#fff;font-size:14px;
}
.textin{min-width:160px}
details{background:#fff;border-radius:14px;padding:10px 12px;margin-bottom:10px}
details > summary{cursor:pointer;font-weight:800;list-style:none}
details > summary::-webkit-details-marker{display:none}
.summaryRow{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
.mono{font-variant-numeric:tabular-nums}

/* ===== ëª¨ë°”ì¼ í‘œ ì¤„ë°”ê¿ˆ ì™„ì „ ì°¨ë‹¨ + ê¸€ì ì¶•ì†Œ + ì—´ ìµœì†Œí­ ===== */
table{table-layout:auto;width:max-content;min-width:100%}
th, td{
  white-space:nowrap !important;
  word-break:keep-all !important;
  text-align:center;
  vertical-align:middle;
}
.badge{white-space:nowrap;display:inline-block}
th:nth-child(2), td:nth-child(2){ min-width:70px; } /* ëª¨ë“œ */
th:nth-child(4), td:nth-child(4){ min-width:60px; } /* íŒì • */
th:nth-child(5), td:nth-child(5){ min-width:70px; } /* ë‹¨ë°±ì§ˆ */
th:nth-child(6), td:nth-child(6){ min-width:70px; } /* ë¬¼ */
@media (max-width:420px){
  th, td{ font-size:12px; padding:6px 8px; }
  .tab, .mode{ font-size:13px; padding:9px; }
}

/* ===== BONUS ë°°ì§€ ===== */
.bonusTag{
  margin-left:8px;
  font-size:12px;
  padding:2px 8px;
  border-radius:999px;
  background:#f1f1f1;
  color:#777;
  font-weight:700;
}

/* ===== íŠ¸ë˜ì»¤ UI ===== */
.trackRow{
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  padding:6px 0;
}
.trackBtns{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.trackBtns button{
  border:none;border-radius:10px;padding:8px 10px;background:#e6e6e6;font-size:13px;
}
.trackBtns button:active{background:#cfcfcf}
.trackStat{font-size:13px;color:#444}
.good{font-weight:800;color:#2e7d32}
.need{font-weight:800;color:#c62828}
.hint{font-size:12px;color:#777;margin-top:6px;line-height:1.35}
</style>
</head>

<body>

<h1>ğŸˆë£¨í‹´ ì²´í¬</h1>
<div class="small" style="text-align:center" id="today"></div>

<!-- TABS -->
<div class="tabs">
  <button class="tab active" id="tabToday" onclick="showTab('today')">â™¥ï¸ì˜¤ëŠ˜</button>
  <button class="tab" id="tabWeek" onclick="showTab('week')">ğŸ““ì£¼ê°„ ìš”ì•½</button>
  <button class="tab" id="tabAll" onclick="showTab('all')">ğŸ“šì „ì²´ ê¸°ë¡</button>
</div>

<!-- MODES -->
<div class="modes">
  <button class="mode" id="mHard" onclick="setMode('hard')">ğŸ˜ªí˜ë“  ë‚ </button>
  <button class="mode" id="mCycle" onclick="setMode('cycle')">ğŸ©¸ìƒë¦¬ì£¼ê¸°</button>
  <button class="mode" id="mTravel" onclick="setMode('travel')">âœˆï¸ì—¬í–‰/ì´íƒˆ</button>
</div>

<!-- TODAY -->
<div id="viewToday">

  <!-- ê³¼ê±° ê¸°ë¡ ìˆ˜ì • -->
  <div class="section">
    <div class="small">ğŸ“… ë‚ ì§œ ì„ íƒ (ê³¼ê±° ê¸°ë¡ ìˆ˜ì •)</div>
    <div style="display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap;">
      <input type="date" id="datePicker" style="padding:8px 10px;border-radius:10px;border:1px solid #ddd;background:#fff;font-size:14px;">
      <button class="btn" style="width:auto;padding:9px 12px" onclick="loadDate()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn" style="width:auto;padding:9px 12px" onclick="backToToday()">ì˜¤ëŠ˜ë¡œ</button>
    </div>
    <div class="small" id="editHint" style="margin-top:6px;color:#c62828;display:none;">
      âš ï¸ ê³¼ê±° ê¸°ë¡ ìˆ˜ì • ì¤‘
    </div>
  </div>

  <!-- ë‹¨ì‹/ë‹¨ë°±ì§ˆ/ë¬¼ íŠ¸ë˜ì»¤ -->
  <div class="section">

    <div class="trackRow">
      <div class="trackStat" id="fastText"></div>
      <div class="trackBtns">
        <button onclick="startFasting()">â›” ë‹¨ì‹ ì‹œì‘</button>
        <button onclick="resetFasting()">ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div class="trackRow">
      <div class="trackStat" id="proteinTrackText"></div>
      <div class="trackBtns">
        <button onclick="addProtein(-20)">â†©ï¸ -20g</button>
        <button onclick="addProtein(-10)">â†©ï¸ -10g</button>
        <button onclick="addProtein(-5)">â†©ï¸ -5g</button>

        <!-- âœ… ë§ˆì´ë„ˆìŠ¤/í”ŒëŸ¬ìŠ¤ ì‚¬ì´ ì¤„ë°”ê¿ˆ -->
        <div style="flex-basis:100%;height:0"></div>

        <button onclick="addProtein(5)">ğŸ¥š +5g</button>
        <button onclick="addProtein(10)">ğŸ¥š +10g</button>
        <button onclick="addProtein(20)">ğŸ¥© +20g</button>
        <button onclick="resetProtein()">ì´ˆê¸°í™”</button>
      </div>
    </div>
    <div class="hint" id="proteinHint"></div>

    <div class="trackRow">
      <div class="trackStat" id="waterText"></div>
      <div class="trackBtns">
        <button onclick="addWater(-WATER_UNIT)">â†©ï¸ -120ml</button>
        <button onclick="addWater(WATER_UNIT)">ğŸ’§ +120ml</button>
        <button onclick="resetWater()">ì´ˆê¸°í™”</button>
      </div>
    </div>

  </div>

  <div id="checklist"></div>

  <div class="result" id="result">ì²´í¬ ì‹œì‘</div>

  <button class="btn" onclick="resetToday()">ì˜¤ëŠ˜ ì²´í¬ ì´ˆê¸°í™”</button>

</div>

<!-- WEEK -->
<div id="viewWeek" class="hide">
  <div class="section">
    <h2>ìµœê·¼ 7ì¼ ìš”ì•½</h2>
    <div class="small" id="weekSummary"></div>
  </div>
  <div class="section" style="overflow:auto">
    <table>
      <thead>
        <tr>
          <th>ë‚ ì§œ</th><th>ëª¨ë“œ</th><th>ì ìˆ˜</th><th>íŒì •</th><th>ë‹¨ë°±ì§ˆ</th><th>ë¬¼</th>
        </tr>
      </thead>
      <tbody id="weekTable"></tbody>
    </table>
  </div>
</div>

<!-- ALL -->
<div id="viewAll" class="hide">
  <div class="section">
    <h2>ì „ì²´ ê¸°ë¡</h2>
    <div class="small" id="allSummary"></div>
    <div style="margin-top:10px" class="controls">
      <select id="allModeFilter">
        <option value="all">ëª¨ë“œ: ì „ì²´</option>
        <option value="base">ê¸°ë³¸</option>
        <option value="cycle">ğŸ©¸ìƒë¦¬ì£¼ê¸°</option>
        <option value="hard">ğŸ˜ªí˜ë“  ë‚ </option>
        <option value="travel">âœˆï¸ì—¬í–‰/ì´íƒˆ</option>
      </select>

      <select id="allVerdictFilter">
        <option value="all">íŒì •: ì „ì²´</option>
        <option value="pass">í•©ê²©</option>
        <option value="mid">ë³´í†µ</option>
        <option value="rest">íšŒë³µ</option>
      </select>

      <input id="allTextFilter" class="textin" placeholder="ê²€ìƒ‰(ë‚ ì§œ/ë‹¨ë°±ì§ˆ/ë¬¼ ë“±)" />
      <button class="btn" style="width:auto;padding:9px 12px" onclick="resetAllFilters()">í•„í„° ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div id="allGroups"></div>
</div>

<script>
/* =========================
   ë‚ ì§œ/ìƒíƒœ ê¸°ë³¸
========================= */
const todayKey = new Date().toISOString().slice(0,10);
document.getElementById("today").innerText = todayKey;
let activeDateKey = todayKey;

/* =========================
   ì„¤ì •ê°’
========================= */
const FAST_HOURS = 14;

const WATER_UNIT = 120;
const WATER_TARGET = 2000;

// âœ… ë‹¨ë°±ì§ˆ: ëª¨ë“œë³„ ìµœì†Œì¹˜ + ì†Œí”„íŠ¸ ìƒí•œ(ê¶Œì¥)
const PROTEIN_TARGETS = { base: 58, hard: 40, cycle: 50, travel: 45 };
const PROTEIN_SOFT_CAP = 100;
function getProteinTarget(mode){ return PROTEIN_TARGETS[mode] ?? 58; }

/* =========================
   ì²´í¬ë¦¬ìŠ¤íŠ¸ (ì‹œê°„+ë‚´ìš© í†µì¼)
========================= */
const BASE_ITEMS = [
  {c:"ì•„ì¹¨",t:"ğŸŒ 10ì‹œ ì „ ê¸°ìƒ",w:1},
  {c:"ì•„ì¹¨",t:"ğŸª¥ ì–‘ì¹˜ + ë¬¼",w:1},
  {c:"ì•„ì¹¨",t:"ğŸ’Š ì˜ì–‘ì œ",w:1},
  {c:"ì•„ì¹¨",t:"ğŸ‹ ë ˆëª¬ë¬¼ ì„¸íŠ¸",w:1},

  {c:"ì ì‹¬",t:"ğŸ’Š ì˜ì–‘ì œ",w:1},
  {c:"ì ì‹¬",t:"ğŸš¶ í™˜ê¸° + 10ë¶„ ì‹í›„ ê±·ê¸°",w:2},

  {c:"ì €ë…",t:"ğŸš¶ 10ë¶„ ì‹í›„ ê±·ê¸°",w:2},

  {c:"ìš´ë™",t:"ğŸª 5ë¶„ ì „ì‹ ìš´ë™ ë˜ëŠ” í´",w:2},
  {c:"ìš´ë™",t:"ğŸ”¥ ë³µë¶€",w:0},
  {c:"ìš´ë™",t:"ğŸ’ª ì–´ê¹¨",w:0},
  {c:"ìš´ë™",t:"ğŸª½ ë“±",w:0},
  {c:"ìš´ë™",t:"ğŸ‘ í™",w:0},
];

const MODES = {
  base: BASE_ITEMS,
  hard: [
    {c:"í•µì‹¬",t:"ğŸ§˜ 5ë¶„ ìŠ¤íŠ¸ë ˆì¹­",w:2},
  ],
  cycle: [
    {c:"í•˜ë£¨",t:"ğŸš¶ 10ë¶„ ê°€ë²¼ìš´ ì›€ì§ì„",w:2},
    {c:"í•˜ë£¨",t:"ğŸ§˜ 5ë¶„ ìŠ¤íŠ¸ë ˆì¹­",w:2},
  ],
  travel: [
    {c:"ì—¬í–‰",t:"ğŸš¶ 10ë¶„ ì‹í›„ ê±·ê¸°",w:2},
  ]
};

const modeLabel = (m) => {
  if(m==="hard") return "ğŸ˜ªí˜ë“  ë‚ ";
  if(m==="cycle") return "ğŸ©¸ìƒë¦¬ì£¼ê¸°";
  if(m==="travel") return "âœˆï¸ì—¬í–‰/ì´íƒˆ";
  return "ê¸°ë³¸";
};

/* =========================
   state ë¡œë“œ/ë³´ì •
========================= */
let state = JSON.parse(localStorage.getItem(activeDateKey))
  || {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStart:null};

function normalizeState(){
  if(!state || typeof state!=="object") state = {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStart:null};
  if(!state.checks || typeof state.checks!=="object") state.checks = {};
  if(typeof state.waterMl !== "number") state.waterMl = 0;
  if(typeof state.proteinG !== "number") state.proteinG = 0;
  if(!("fastingStart" in state)) state.fastingStart = null;
  if(!state.mode) state.mode = "base";
}
normalizeState();

function save(){
  localStorage.setItem(activeDateKey, JSON.stringify(state));
}

/* =========================
   ëª¨ë“œ/ë Œë”
========================= */
function setMode(m){
  state.mode = (state.mode===m) ? "base" : m;
  save();
  render();
}

function render(){
  normalizeState();

  ["mHard","mCycle","mTravel"].forEach(id=>document.getElementById(id).classList.remove("on"));
  if(state.mode==="hard") mHard.classList.add("on");
  if(state.mode==="cycle") mCycle.classList.add("on");
  if(state.mode==="travel") mTravel.classList.add("on");

  const items = MODES[state.mode];
  const wrap = document.getElementById("checklist");
  wrap.innerHTML="";
  let cur="";

  items.forEach((it,i)=>{
    if(it.c!==cur){
      cur=it.c;
      const s=document.createElement("div");
      s.className="section";
      s.innerHTML=`<h2>${cur}</h2>`;
      wrap.appendChild(s);
    }
    const id = state.mode + "_" + i;
    const lbl=document.createElement("label");
    const bonus = (it.w===0) ? `<span class="bonusTag">BONUS</span>` : "";
    lbl.innerHTML = `<input type="checkbox" ${state.checks[id]?"checked":""}> ${it.t}${bonus}`;
    lbl.querySelector("input").onchange = e => {
      state.checks[id] = e.target.checked;
      save(); update();
    };
    wrap.lastChild.appendChild(lbl);
  });

  // datePicker: ë¹ˆ () ë°©ì§€ + ë¯¸ë˜ ì°¨ë‹¨
  const dp = document.getElementById("datePicker");
  if(dp){
    dp.max = todayKey;
    dp.value = activeDateKey; // âœ… ë¹ˆ date input í‘œì‹œ(()) ë°©ì§€
  }

  update();
}

/* =========================
   ë‹¨ì‹ íŠ¸ë˜í‚¹
========================= */
function startFasting(){
  if(state.fastingStart){
    if(!confirm("ë‹¨ì‹ ì‹œì‘ ì‹œê°„ì„ ìƒˆë¡œ ê¸°ë¡í• ê¹Œ?")) return;
  }
  state.fastingStart = new Date().toISOString();
  save(); update();
}
function resetFasting(){
  state.fastingStart = null;
  save(); update();
}
function fmtHM(d){
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}
function renderFasting(){
  const el = document.getElementById("fastText");
  if(!el) return;

  if(!state.fastingStart){
    el.innerHTML = `â›” ${FAST_HOURS}ì‹œê°„ ë‹¨ì‹ (ì‹œì‘ ì•ˆ í•¨)`;
    return;
  }
  const start = new Date(state.fastingStart);
  const end = new Date(start.getTime() + FAST_HOURS*60*60*1000);
  const now = new Date();

  if(now >= end){
    el.innerHTML = `â›” ${FAST_HOURS}ì‹œê°„ ë‹¨ì‹ (âœ… ì‹ì‚¬ ê°€ëŠ¥: <span class="good">${fmtHM(end)}</span>)`;
  }else{
    const ms = end - now;
    const h = Math.floor(ms/(60*60*1000));
    const m = Math.floor((ms%(60*60*1000))/(60*1000));
    el.innerHTML = `â›” ${FAST_HOURS}ì‹œê°„ ë‹¨ì‹ (ì‹ì‚¬ ê°€ëŠ¥: <span class="need">${fmtHM(end)}</span> / ë‚¨ì€ ${h}ì‹œê°„ ${m}ë¶„)`;
  }
}

/* =========================
   ë‹¨ë°±ì§ˆ íŠ¸ë˜í‚¹
========================= */
function addProtein(delta){
  const next = Math.max(0, (state.proteinG||0) + delta);
  state.proteinG = next;
  save(); update();
}
function resetProtein(){
  state.proteinG = 0;
  save(); update();
}
function renderProtein(){
  const g = state.proteinG || 0;
  const target = getProteinTarget(state.mode || "base");
  const left = Math.max(0, target - g);
  const ok = g >= target;

  const capMsg = (g > PROTEIN_SOFT_CAP)
    ? ` Â· <span class="need">ìƒí•œ ${PROTEIN_SOFT_CAP}gâ†‘</span>`
    : "";

  document.getElementById("proteinTrackText").innerHTML =
    ok
    ? `ğŸ¥© ë‹¨ë°±ì§ˆ <span class="good">${g}g</span> (âœ… ìµœì†Œ ${target}g ë‹¬ì„±${capMsg})`
    : `ğŸ¥© ë‹¨ë°±ì§ˆ <span class="need">${g}g</span> (ë‚¨ì€ ${left}g / ìµœì†Œ ${target}g${capMsg})`;

  // ì† ë¶ˆí¸ ë°©ì§€ìš© ì•„ì£¼ ì§§ì€ ì•ˆë‚´(ì²´í¬ í•­ëª© ì•„ë‹˜)
  const hintEl = document.getElementById("proteinHint");
  if(hintEl){
    hintEl.innerText = `TIP: ë‹¨ë°±ì§ˆë§Œ ëª°ì•„ë¨¹ìœ¼ë©´ ì†ì´ ë¶ˆí¸í•  ìˆ˜ ìˆì–´. ë‹¨ë°±ì§ˆ ì˜¬ë¦´ ë• ë°¥/ê³¼ì¼/ê²¬ê³¼ì²˜ëŸ¼ í•œ ì… ê°™ì´. (ê¶Œì¥ ìƒí•œ ${PROTEIN_SOFT_CAP}g)`;
  }
}

/* =========================
   ë¬¼ íŠ¸ë˜í‚¹
========================= */
function addWater(delta){
  const next = Math.max(0, (state.waterMl||0) + delta);
  state.waterMl = next;
  save(); update();
}
function resetWater(){
  state.waterMl = 0;
  save(); update();
}
function renderWater(){
  const ml = state.waterMl || 0;
  const left = Math.max(0, WATER_TARGET - ml);
  const cups = Math.floor(ml / WATER_UNIT);
  const ok = ml >= WATER_TARGET;

  document.getElementById("waterText").innerHTML =
    ok
    ? `ğŸ’§ ë¬¼ <span class="good">${ml}ml</span> (âœ… ëª©í‘œ ${WATER_TARGET}ml ë‹¬ì„±)`
    : `ğŸ’§ ë¬¼ <span class="need">${ml}ml</span> (ë‚¨ì€ ${left}ml / ${cups}íšŒ)`;
}

/* =========================
   ë‚ ì§œ ë¶ˆëŸ¬ì˜¤ê¸°(ê³¼ê±°ë§Œ)
========================= */
function loadDate(){
  const d = document.getElementById("datePicker").value;
  if(!d) return alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì¤˜");
  if(d > todayKey) return alert("ë¯¸ë˜ ë‚ ì§œëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ì–´.");

  activeDateKey = d;
  state = JSON.parse(localStorage.getItem(activeDateKey))
    || {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStart:null};
  normalizeState();

  document.getElementById("today").innerText = activeDateKey + " (ìˆ˜ì •ì¤‘)";
  document.getElementById("editHint").style.display = "block";

  render();
}

function backToToday(){
  activeDateKey = todayKey;
  state = JSON.parse(localStorage.getItem(activeDateKey))
    || {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStart:null};
  normalizeState();

  document.getElementById("today").innerText = todayKey;
  document.getElementById("editHint").style.display = "none";

  render();
}

/* =========================
   íŒì • ê³„ì‚°
========================= */
function verdictFromRatio(ratio){
  if(ratio>=0.6) return {key:"pass", cls:"ok", txt:"í•©ê²©"};
  if(ratio>=0.3) return {key:"mid", cls:"midb", txt:"ë³´í†µ"};
  return {key:"rest", cls:"restb", txt:"íšŒë³µ"};
}

function calcStats(s){
  const mode = s.mode || "base";
  const items = MODES[mode] || MODES.base;
  let score=0,total=0;

  items.forEach((it,i)=>{
    const id = mode + "_" + i;
    if(it.w>0){ total += it.w; if(s.checks && s.checks[id]) score += it.w; }
  });

  const proteinG = (typeof s.proteinG==="number") ? s.proteinG : 0;
  const waterMl  = (typeof s.waterMl==="number")  ? s.waterMl  : 0;
  const fasting  = s.fastingStart ? 1 : 0;

  // âœ… ë‹¨ë°±ì§ˆ(ê°€ì¤‘ì¹˜ 2) / ë¬¼(ê°€ì¤‘ì¹˜ 1) / ë‹¨ì‹ ì‹œì‘(ê°€ì¤‘ì¹˜ 1)
  const proteinTarget = getProteinTarget(mode);
  total += 2; if(proteinG >= proteinTarget) score += 2;
  total += 1; if(waterMl >= WATER_TARGET) score += 1;
  total += 1; if(fasting) score += 1;

  const ratio = total ? (score/total) : 0;
  return { mode, score, total, ratio, proteinG, waterMl };
}

/* =========================
   ì—…ë°ì´íŠ¸/ì´ˆê¸°í™”
========================= */
function update(){
  renderFasting();
  renderProtein();
  renderWater();

  const st = calcStats(state);
  const r=document.getElementById("result");
  const v = verdictFromRatio(st.ratio);

  if(v.key==="pass"){ r.innerText="ì˜¤ëŠ˜ í•©ê²© âœ…"; r.className="result pass"; }
  else if(v.key==="mid"){ r.innerText="ë³´í†µ ğŸ™‚"; r.className="result mid"; }
  else { r.innerText="íšŒë³µ ë°ì´ ğŸŒ±"; r.className="result rest"; }
}

function resetToday(){
  if(confirm("í˜„ì¬ ì„ íƒëœ ë‚ ì§œì˜ ì²´í¬ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")){
    state = {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStart:null};
    save(); render();
  }
}

/* =========================
   íƒ­/ìš”ì•½
========================= */
function showTab(t){
  tabToday.classList.toggle("active", t==="today");
  tabWeek.classList.toggle("active", t==="week");
  tabAll.classList.toggle("active", t==="all");

  viewToday.classList.toggle("hide", t!=="today");
  viewWeek.classList.toggle("hide", t!=="week");
  viewAll.classList.toggle("hide", t!=="all");

  if(t==="week") renderWeek();
  if(t==="all") renderAll();
}

function renderWeek(){
  const body=document.getElementById("weekTable");
  body.innerHTML="";
  let pass=0, mid=0, rest=0;

  for(let i=6;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    const k=d.toISOString().slice(0,10);
    const s=JSON.parse(localStorage.getItem(k)||"null");
    if(!s || !s.checks) continue;

    const st = calcStats(s);
    const v = verdictFromRatio(st.ratio);
    if(v.key==="pass") pass++;
    else if(v.key==="mid") mid++;
    else rest++;

    body.innerHTML += `
      <tr>
        <td>${k}</td>
        <td>${modeLabel(st.mode)}</td>
        <td class="mono">${st.score}/${st.total}</td>
        <td><span class="badge ${v.cls}">${v.txt}</span></td>
        <td class="mono">${st.proteinG}g</td>
        <td class="mono">${st.waterMl}ml</td>
      </tr>`;
  }

  document.getElementById("weekSummary").innerText =
    `í•©ê²© ${pass}ì¼ Â· ë³´í†µ ${mid}ì¼ Â· íšŒë³µ ${rest}ì¼`;
}

/* ===== ALL: group by month + filters ===== */
const dateRe = /^\d{4}-\d{2}-\d{2}$/;

function getAllKeys(){
  const keys=[];
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(dateRe.test(k)) keys.push(k);
  }
  keys.sort((a,b)=> b.localeCompare(a));
  return keys;
}

function resetAllFilters(){
  document.getElementById("allModeFilter").value="all";
  document.getElementById("allVerdictFilter").value="all";
  document.getElementById("allTextFilter").value="";
  renderAll();
}

function renderAll(){
  const modeF = document.getElementById("allModeFilter").value;
  const verF  = document.getElementById("allVerdictFilter").value;
  const txtF  = document.getElementById("allTextFilter").value.trim().toLowerCase();

  const keys = getAllKeys();
  const groups = {};
  let totalDays=0, pass=0, mid=0, rest=0;

  keys.forEach(k=>{
    const s = JSON.parse(localStorage.getItem(k)||"null");
    if(!s || !s.checks) return;

    const st = calcStats(s);
    const v  = verdictFromRatio(st.ratio);

    if(modeF!=="all" && (st.mode||"base") !== modeF) return;
    if(verF!=="all" && v.key !== verF) return;
    if(txtF){
      const hay = `${k} ${modeLabel(st.mode)} ${v.txt} ${st.proteinG} ${st.waterMl}`.toLowerCase();
      if(!hay.includes(txtF)) return;
    }

    totalDays++;
    if(v.key==="pass") pass++;
    else if(v.key==="mid") mid++;
    else rest++;

    const ym = k.slice(0,7);
    groups[ym] = groups[ym] || [];
    groups[ym].push({date:k, mode:st.mode, score:st.score, total:st.total, v, proteinG:st.proteinG, waterMl:st.waterMl});
  });

  document.getElementById("allSummary").innerText =
    `í•„í„° ê²°ê³¼: ${totalDays}ì¼ Â· í•©ê²© ${pass} Â· ë³´í†µ ${mid} Â· íšŒë³µ ${rest} (ì›”ë³„ë¡œ ëˆŒëŸ¬ í¼ì¹˜ê¸°)`;

  const wrap = document.getElementById("allGroups");
  wrap.innerHTML = "";

  const months = Object.keys(groups).sort((a,b)=> b.localeCompare(a));
  if(months.length===0){
    wrap.innerHTML = `<div class="section"><div class="small">ê¸°ë¡ì´ ì—†ê±°ë‚˜ í•„í„° ì¡°ê±´ì— ë§ëŠ” ê¸°ë¡ì´ ì—†ì–´.</div></div>`;
    return;
  }

  months.forEach((ym, idx)=>{
    const rows = groups[ym];

    let mp=0, mm=0, mr=0;
    rows.forEach(r=>{
      if(r.v.key==="pass") mp++;
      else if(r.v.key==="mid") mm++;
      else mr++;
    });

    const det = document.createElement("details");
    if(idx===0) det.open = true;

    det.innerHTML = `
      <summary>
        <div class="summaryRow">
          <div>${ym} <span class="small">(í•©ê²© ${mp} Â· ë³´í†µ ${mm} Â· íšŒë³µ ${mr})</span></div>
          <div class="small">ëˆŒëŸ¬ì„œ í¼ì¹˜ê¸°</div>
        </div>
      </summary>
      <div style="overflow:auto; margin-top:8px;">
        <table>
          <thead>
            <tr>
              <th>ë‚ ì§œ</th><th>ëª¨ë“œ</th><th>ì ìˆ˜</th><th>íŒì •</th><th>ë‹¨ë°±ì§ˆ</th><th>ë¬¼</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td>${r.date}</td>
                <td>${modeLabel(r.mode)}</td>
                <td class="mono">${r.score}/${r.total}</td>
                <td><span class="badge ${r.v.cls}">${r.v.txt}</span></td>
                <td class="mono">${r.proteinG}g</td>
                <td class="mono">${r.waterMl}ml</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `;
    wrap.appendChild(det);
  });
}

document.getElementById("allModeFilter").onchange = renderAll;
document.getElementById("allVerdictFilter").onchange = renderAll;
document.getElementById("allTextFilter").oninput = () => {
  clearTimeout(window.__rt);
  window.__rt = setTimeout(renderAll, 120);
};

/* =========================
   init + ë‹¨ì‹ í…ìŠ¤íŠ¸ ì£¼ê¸° ê°±ì‹ 
========================= */
render();
setInterval(()=>{ renderFasting(); }, 60*1000);

// PWA
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{ navigator.serviceWorker.register("./sw.js").catch(()=>{}); });
}
</script>

</body>
</html>
