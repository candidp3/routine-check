<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸˆë£¨í‹´ ì²´í¬</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#222222">

<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f6f6f6;margin:0;padding:14px;color:#222}
h1{text-align:center;margin:6px 0}
.small{font-size:13px;color:#666}
.tabs,.modes{display:flex;gap:8px;margin:12px 0}
.tab,.mode{flex:1;padding:10px;border-radius:12px;border:none;background:#e6e6e6;font-size:14px}
.tab.active,.mode.on{background:#cfcfcf;font-weight:700}
.section{background:#fff;border-radius:14px;padding:12px;margin-bottom:10px}
.section h2{margin:0 0 8px;font-size:16px}
label{display:flex;align-items:center;gap:8px;padding:6px 0}
input[type=checkbox]{width:18px;height:18px}
.result{text-align:center;font-size:20px;font-weight:800;margin:14px 0}
.pass{color:#2e7d32}.mid{color:#f9a825}.rest{color:#c62828}
.btn{width:100%;padding:10px;border-radius:12px;border:none;background:#e6e6e6;font-size:14px}
.btn:active{background:#cfcfcf}
.hide{display:none}

table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eee;font-size:13px}
th{text-align:left;color:#666}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
.ok{background:#e7f6ea;color:#2e7d32}
.midb{background:#fff4d6;color:#f9a825}
.restb{background:#fde7e7;color:#c62828}

.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,.textin{
  padding:8px 10px;border-radius:10px;border:1px solid #ddd;background:#fff;font-size:14px;
}
.textin{min-width:160px}
details{background:#fff;border-radius:14px;padding:10px 12px;margin-bottom:10px}
details > summary{cursor:pointer;font-weight:800;list-style:none}
details > summary::-webkit-details-marker{display:none}
.summaryRow{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
.mono{font-variant-numeric:tabular-nums}

/* ===== ëª¨ë°”ì¼ í‘œ ì¤„ë°”ê¿ˆ ì™„ì „ ì°¨ë‹¨ + ê¸€ì ì¶•ì†Œ + ì—´ ìµœì†Œí­ ===== */
table{table-layout:auto;width:max-content;min-width:100%}
th, td{
  white-space:nowrap !important;
  word-break:keep-all !important;
  text-align:center;
  vertical-align:middle;
}
.badge{white-space:nowrap;display:inline-block}
th:nth-child(2), td:nth-child(2){ min-width:70px; } /* ëª¨ë“œ */
th:nth-child(4), td:nth-child(4){ min-width:60px; } /* íŒì • */
th:nth-child(5), td:nth-child(5){ min-width:70px; } /* ë‹¨ë°±ì§ˆ */
th:nth-child(6), td:nth-child(6){ min-width:70px; } /* ë¬¼ */
@media (max-width:420px){
  th, td{ font-size:12px; padding:6px 8px; }
  .tab, .mode{ font-size:13px; padding:9px; }
}

/* ===== BONUS ë°°ì§€ ===== */
.bonusTag{
  margin-left:8px;
  font-size:10px;
  padding:2px 8px;
  border-radius:999px;
  background:#f1f1f1;
  color:#777;
  font-weight:700;
}

/* ===== íŠ¸ë˜ì»¤ UI ===== */
.trackRow{
  display:flex;
  align-items:flex-start;
  gap:12px;
  padding:6px 0;
}

.trackBtns{
  margin-left:auto;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  justify-content:flex-end;
}

.trackBtns button{
  border:none;
  border-radius:10px;
  padding:6px 8px;
  background:#e6e6e6;
  font-size:13px;
}
.trackBtns button:active{background:#cfcfcf}
.trackStat{font-size:13px;color:#444}
.good{font-weight:800;color:#2e7d32}
.need{font-weight:800;color:#c62828}
.hint{font-size:12px;color:#777;margin-top:6px;line-height:1.35}

.trackBtns button.reset{
  background:#f1f1f1;
  font-size:12px;
  opacity:0.7;
}

.proteinBtn{
  width:80px;          /* â† ì´ ìˆ«ìë§Œ ì·¨í–¥ì— ë§ê²Œ ì¡°ì ˆ */
  padding:8px 0;
  font-size:12px;
  text-align:center;
}

#deleteFastingBtn{
  padding:4px 6px;
  font-size:11px;
  opacity:0.6;
}
#deleteFastingBtn:hover{
  opacity:1;
}

.checkCategory{
  margin-top:10px;
  font-weight:700;
  font-size:13px;
  color:#333;
}

/* ì²´í¬ë¦¬ìŠ¤íŠ¸ ì „ìš© ê¸€ì”¨ í¬ê¸° ë³µêµ¬ */
.checkItem{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:15px;   /* â† ì´ì „ í¬ê¸°ë¡œ */
  color:#222;
  margin:6px 0;
}

.sectionTitle{
  font-weight:700;
  font-size:14px;
  margin-bottom:6px;
}

.checkItem input[type="checkbox"]{
  width:15px;
  height:15px;
  transform: scale(0.9);
}

@media (max-width: 480px){
  .trackBtns button{
    padding:5px 7px;
    font-size:11px;
  }
}

.weeklyTable{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
.weeklyTable th,
.weeklyTable td{
  border-bottom:1px solid #eee;
  padding:6px;
  text-align:center;
}
.weeklyTable th{
  background:#fafafa;
  font-weight:700;
}

</style>
</head>

<body>

<h1>ğŸˆë£¨í‹´ ì²´í¬</h1>
<div class="small" style="text-align:center" id="today"></div>

<!-- TABS -->
<div class="tabs">
  <button class="tab active" id="tabToday" onclick="showTab('today')">â™¥ï¸ì˜¤ëŠ˜</button>
  <button class="tab" id="tabWeek" onclick="showTab('week')">ğŸ““ì£¼ê°„ ìš”ì•½</button>
  <button class="tab" id="tabAll" onclick="showTab('all')">ğŸ“šì „ì²´ ê¸°ë¡</button>
</div>

<!-- MODES -->
<div class="modes">
  <button class="mode" id="mHard" onclick="setMode('hard')">ğŸ˜ªí˜ë“  ë‚ </button>
  <button class="mode" id="mCycle" onclick="setMode('cycle')">ğŸ©¸ìƒë¦¬ì£¼ê¸°</button>
  <button class="mode" id="mTravel" onclick="setMode('travel')">âœˆï¸ì—¬í–‰/ì´íƒˆ</button>
</div>

<!-- TODAY -->
<div id="viewToday">

  <!-- ê³¼ê±° ê¸°ë¡ ìˆ˜ì • -->
  <div class="section">
    <div class="small">ğŸ“… ë‚ ì§œ ì„ íƒ</div>
    <div style="display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap;">
      <input type="date" id="datePicker" style="padding:6px 10px;border-radius:10px;border:1px solid #ddd;background:#fff;font-size:14px;">
      <button class="btn" style="width:auto;padding:6px 11px" onclick="loadDate()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn" style="width:auto;padding:6px 11px" onclick="backToToday()">ì˜¤ëŠ˜ë¡œ</button>
    </div>
    <div class="small" id="editHint" style="margin-top:6px;color:#c62828;display:none;">
      âš ï¸ ê³¼ê±° ê¸°ë¡ ìˆ˜ì • ì¤‘
    </div>
  </div>

  <!-- ë‹¨ì‹/ë‹¨ë°±ì§ˆ/ë¬¼/ìˆ˜ë©´ íŠ¸ë˜ì»¤ -->
  <div class="section">

    <div class="trackRow">
      <div class="trackStat" id="fastText"></div>
      <div class="trackBtns">
        <button class="reset" onclick="cancelFasting()">ì´ˆê¸°í™”</button>
        <button onclick="startFasting()">â›” ì‹œì‘</button>
        <button onclick="endFasting()">âœ… ì¢…ë£Œ</button>
        <button id="deleteFastingBtn"
                class="reset"
                onclick="deleteFastingRecord()"
                style="display:none"
                >ğŸ—‘</button>
      </div>
    </div>
    <div class="hint" id="proteinHint"></div>

    <div class="trackRow">
      <div class="trackStat" id="proteinTrackText"></div>
      <div class="trackBtns">
        <button class="reset" onclick="resetProtein()">ì´ˆê¸°í™”</button>
       <button class="proteinBtn" onclick="addProtein(-20)">â†©ï¸ -20g</button>
        <button class="proteinBtn" onclick="addProtein(-10)">â†©ï¸ -10g</button>
        <button class="proteinBtn" onclick="addProtein(-5)">â†©ï¸ -5g</button>

        <!-- âœ… ë§ˆì´ë„ˆìŠ¤/í”ŒëŸ¬ìŠ¤ ì‚¬ì´ ì¤„ë°”ê¿ˆ -->
        <div style="flex-basis:100%;height:0"></div>

        <button class="proteinBtn" onclick="addProtein(5)">ğŸ¥š +5g</button>
        <button class="proteinBtn" onclick="addProtein(10)">ğŸ— +10g</button>
        <button class="proteinBtn" onclick="addProtein(20)">ğŸ¥© +20g</button>
      </div>
    </div>

    <div class="trackRow">
      <div class="trackStat" id="waterText"></div>
      <div class="trackBtns">
        <button class="reset" onclick="resetWater()">ì´ˆê¸°í™”</button>
        <button onclick="addWater(-WATER_UNIT)">â†©ï¸ -120ml</button>
        <button onclick="addWater(WATER_UNIT)">ğŸ’§ +120ml</button>
      </div>
    </div>
    <div class="trackRow">
      <div class="trackStat" id="sleepText"></div>
      <div class="trackBtns">
        <button class="reset" onclick="cancelSleep()">ì´ˆê¸°í™”</button>
        <button onclick="startSleep()">ğŸŒ™ ì·¨ì¹¨</button>
        <button onclick="endSleep()">â˜€ï¸ ê¸°ìƒ</button>
      </div>
    </div>   

  </div>

  <div id="checklist"></div>

  <div class="result" id="result">ì²´í¬ ì‹œì‘</div>

  <button class="btn" onclick="resetToday()">ì˜¤ëŠ˜ ì²´í¬ ì´ˆê¸°í™”</button>

</div>

<!-- WEEK -->
<div id="viewWeek" class="hide">
  <div class="section">
    <h2>ìµœê·¼ 7ì¼ ìš”ì•½</h2>
    <div class="small" id="weekSummary"></div>
  </div>
  <div class="section" style="overflow:auto">
    <table>
      <thead>
        <tr>
          <th>ë‚ ì§œ</th>
          <th>ëª¨ë“œ</th>
          <th>íŒì •</th>
          <th>ë‹¨ë°±ì§ˆ</th>
          <th>ë¬¼</th>
          <th>ë‹¨ì‹</th>
          <th>ìˆ˜ë©´</th>
        </tr>
      </thead>
      <tbody id="weekTable"></tbody>
    </table>
  </div>
</div>

<!-- ALL v2 -->
<div id="viewAll_v2" class="hide">
  <div class="section">
    <h2>ì „ì²´ ê¸°ë¡</h2>
    <div class="controls" style="margin-top:8px">
      <select id="allModeFilter_v2">
        <option value="all">ëª¨ë“œ: ì „ì²´</option>
        <option value="base">ê¸°ë³¸</option>
        <option value="cycle">ğŸ©¸ìƒë¦¬ì£¼ê¸°</option>
        <option value="hard">ğŸ˜ªí˜ë“  ë‚ </option>
        <option value="travel">âœˆï¸ì—¬í–‰/ì´íƒˆ</option>
      </select>
    
      <select id="allVerdictFilter_v2">
        <option value="all">íŒì •: ì „ì²´</option>
        <option value="pass">í•©ê²©</option>
        <option value="mid">ë³´í†µ</option>
        <option value="rest">íšŒë³µ</option>
      </select>
    </div>

    <div class="small" id="allSummary_v2"></div>
  </div>
</div>

<script>
/* =========================
   ë‚ ì§œ/ìƒíƒœ ê¸°ë³¸
========================= */
/* ===== ë¡œì»¬ ë‚ ì§œ í‚¤(UTC ì˜¤ì°¨ ë°©ì§€) ===== */
function getLocalDateKey(d=new Date()){
  // sv-SEëŠ” YYYY-MM-DD í¬ë§·ì„ ì•ˆì •ì ìœ¼ë¡œ ë°˜í™˜
  return d.toLocaleDateString('sv-SE');
}
const todayKey = getLocalDateKey(new Date());
document.getElementById("today").innerText = todayKey;
let activeDateKey = todayKey;

/* =========================
   ì„¤ì •ê°’
========================= */
const FAST_HOURS = 14;

/* ===== ë‹¨ì‹ ì„¸ì…˜(ë‚ ì§œë¥¼ ë„˜ì–´ ì´ì–´ì§€ê²Œ) =====
   - ì§„í–‰ ì¤‘ ë‹¨ì‹ì€ ë‚ ì§œ(state)ì™€ ë¶„ë¦¬í•´ì„œ ì €ì¥
   - ì¢…ë£Œ ì‹œ "ì˜¤ëŠ˜(todayKey)" ê¸°ë¡ìœ¼ë¡œ ì €ì¥
========================================== */
const FAST_SESSION_KEY = "__fastingSession_v1";
const SLEEP_SESSION_KEY = "sleep_session";

function loadFastSession(){
  try{
    return JSON.parse(localStorage.getItem(FAST_SESSION_KEY) || "null");
  }catch(e){ return null; }
}
function saveFastSession(obj){
  localStorage.setItem(FAST_SESSION_KEY, JSON.stringify(obj));
}
function clearFastSession(){
  localStorage.removeItem(FAST_SESSION_KEY);
}

function loadSleepSession(){
  return JSON.parse(localStorage.getItem(SLEEP_SESSION_KEY) || "null");
}
function saveSleepSession(v){
  localStorage.setItem(SLEEP_SESSION_KEY, JSON.stringify(v));
}
function clearSleepSession(){
  localStorage.removeItem(SLEEP_SESSION_KEY);
}

const WATER_UNIT = 120;
const WATER_TARGET = 2000;

// âœ… ë‹¨ë°±ì§ˆ: ëª¨ë“œë³„ ìµœì†Œì¹˜ + ì†Œí”„íŠ¸ ìƒí•œ(ê¶Œì¥)
const PROTEIN_TARGETS = { base: 58, hard: 40, cycle: 50, travel: 45 };
const PROTEIN_SOFT_CAP = 100;
function getProteinTarget(mode){ return PROTEIN_TARGETS[mode] ?? 58; }

/* =========================
   ì²´í¬ë¦¬ìŠ¤íŠ¸ (ì‹œê°„+ë‚´ìš© í†µì¼)
========================= */
const BASE_ITEMS = [
  {c:"ì•„ì¹¨",t:"ğŸŒ 10ì‹œ ì „ ê¸°ìƒ",w:1},
  {c:"ì•„ì¹¨",t:"ğŸª¥ ì–‘ì¹˜ + ë¬¼",w:1},
  {c:"ì•„ì¹¨",t:"ğŸ’Š ì˜ì–‘ì œ",w:1},
  {c:"ì•„ì¹¨",t:"ğŸ‹ ë ˆëª¬ë¬¼ ì„¸íŠ¸",w:1},

  {c:"ì ì‹¬",t:"ğŸ’Š ì˜ì–‘ì œ",w:1},
  {c:"ì ì‹¬",t:"ğŸƒ í™˜ê¸°",w:1},
  {c:"ì ì‹¬",t:"ğŸ  ê°€ë²¼ìš´ í™œë™",w:2},

  {c:"ì €ë…",t:"ğŸ§´ ë¦¼í”„ ë§ˆì‚¬ì§€",w:2},

];

const MODES = {
  base: BASE_ITEMS,
  hard: [
    {c:"í•µì‹¬",t:"ğŸ˜˜ ë”± 5ë¶„ë§Œ ì›€ì§ì´ì",w:2},
  ],
  cycle: [
    {c:"í•˜ë£¨",t:"ğŸ˜˜ ë”± 5ë¶„ë§Œ ì›€ì§ì´ì",w:2},
    {c:"í•˜ë£¨",t:"ğŸ  ì‹í›„ ê°€ë²¼ìš´ í™œë™",w:2},
  ],
  travel: [
    {c:"ì—¬í–‰",t:"ğŸ§˜ ìŠ¤íŠ¸ë ˆì¹­",w:2},
  ]
};

const modeLabel = (m) => {
  if(m==="hard") return "ğŸ˜ªí˜ë“  ë‚ ";
  if(m==="cycle") return "ğŸ©¸ìƒë¦¬ì£¼ê¸°";
  if(m==="travel") return "âœˆï¸ì—¬í–‰/ì´íƒˆ";
  return "ê¸°ë³¸";
};

/* =========================
   state ë¡œë“œ/ë³´ì •
========================= */
let state = JSON.parse(localStorage.getItem(activeDateKey))
  || {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStartAt:null,fastingEndAt:null,fastingMinutes:null};

function normalizeState(){
  if(!state || typeof state!=="object") state = {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStartAt:null,fastingEndAt:null,fastingMinutes:null};
  if(!state.checks || typeof state.checks!=="object") state.checks = {};
  if(typeof state.waterMl !== "number") state.waterMl = 0;
  if(typeof state.proteinG !== "number") state.proteinG = 0;

  // âœ… êµ¬ë²„ì „ í˜¸í™˜: fastingStart â†’ fastingStartAt
  if(state.fastingStart && !state.fastingStartAt){
    state.fastingStartAt = state.fastingStart;
  }
  // í•„ë“œ ë³´ì •
  if(!("fastingStartAt" in state)) state.fastingStartAt = null;
  if(!("fastingEndAt" in state)) state.fastingEndAt = null;
  if(!("fastingMinutes" in state)) state.fastingMinutes = null;

  if(!state.mode) state.mode = "base";
}
normalizeState();

function save(){
  localStorage.setItem(activeDateKey, JSON.stringify(state));
}

/* =========================
   ëª¨ë“œ/ë Œë”
========================= */
function setMode(m){
  state.mode = (state.mode===m) ? "base" : m;
  save();
  render();
}

function render(){
  normalizeState();

  ["mHard","mCycle","mTravel"].forEach(id=>document.getElementById(id).classList.remove("on"));
  if(state.mode==="hard") mHard.classList.add("on");
  if(state.mode==="cycle") mCycle.classList.add("on");
  if(state.mode==="travel") mTravel.classList.add("on");

  const items = MODES[state.mode];
  const wrap = document.getElementById("checklist");
  wrap.innerHTML="";
  let cur="";

  items.forEach((it,i)=>{
    if(it.c!==cur){
      cur=it.c;
      const s=document.createElement("div");
      s.className="section";
      s.innerHTML=`<h2>${cur}</h2>`;
      wrap.appendChild(s);
    }
    const id = state.mode + "_" + i;
    const lbl=document.createElement("label");
    const bonus = (it.w===0) ? `<span class="bonusTag">BONUS</span>` : "";
    lbl.innerHTML = `<input type="checkbox" ${state.checks[id]?"checked":""}> ${it.t}${bonus}`;
    lbl.querySelector("input").onchange = e => {
      state.checks[id] = e.target.checked;
      save(); update();
    };
    wrap.lastChild.appendChild(lbl);
  });

  // datePicker: ë¹ˆ () ë°©ì§€ + ë¯¸ë˜ ì°¨ë‹¨
  const dp = document.getElementById("datePicker");
  if(dp){
    dp.max = todayKey;
    dp.value = activeDateKey; // âœ… ë¹ˆ date input í‘œì‹œ(()) ë°©ì§€
  }

  update();
}

/* =========================
   ë‹¨ì‹ íŠ¸ë˜í‚¹ (ì‹œì‘â†’ì¢…ë£Œ, ë‚ ì§œ ë„˜ì–´ ìœ ì§€)
========================= */
function fmtHM(d){
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}
function fmtDuration(mins){
  const m = Math.max(0, Math.round(mins));
  const h = Math.floor(m/60);
  const mm = m % 60;
  return `${h}ì‹œê°„ ${mm}ë¶„`;
}

function getStateForKey(k){
  const s = JSON.parse(localStorage.getItem(k) || "null")
    || {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStartAt:null,fastingEndAt:null,fastingMinutes:null};
  // êµ¬ë²„ì „ í˜¸í™˜
  if(s.fastingStart && !s.fastingStartAt) s.fastingStartAt = s.fastingStart;
  if(!("fastingStartAt" in s)) s.fastingStartAt = null;
  if(!("fastingEndAt" in s)) s.fastingEndAt = null;
  if(!("fastingMinutes" in s)) s.fastingMinutes = null;
  if(!s.checks || typeof s.checks!=="object") s.checks = {};
  if(typeof s.waterMl !== "number") s.waterMl = 0;
  if(typeof s.proteinG !== "number") s.proteinG = 0;
  if(!s.mode) s.mode = "base";
  return s;
}
function saveStateForKey(k, s){
  localStorage.setItem(k, JSON.stringify(s));
}

function startFasting(){
  const sess = loadFastSession();
  if(sess && sess.startAt){
    if(!confirm("ì´ë¯¸ ë‹¨ì‹ì´ ì§„í–‰ ì¤‘ì´ì•¼. ìƒˆ ë‹¨ì‹ì„ ì‹œì‘í•˜ë©´ ì´ì „ ë‹¨ì‹ì€ ì·¨ì†Œë¼. ê³„ì†í• ê¹Œ?")) return;
  }
  saveFastSession({ startAt: new Date().toISOString() });
  update();
}

function endFasting(){
  const sess = loadFastSession();
  if(!sess || !sess.startAt){
    alert("ì¢…ë£Œí•  ë‹¨ì‹ì´ ì—†ì–´. ë¨¼ì € 'ë‹¨ì‹ ì‹œì‘'ì„ ëˆŒëŸ¬ì¤˜.");
    return;
  }
  const start = new Date(sess.startAt);
  const end = new Date();
  const mins = (end - start) / (60*1000);

  // âœ… ì¢…ë£Œí•œ 'ì˜¤ëŠ˜'ì— ê¸°ë¡ìœ¼ë¡œ ì €ì¥ (ë‚ ì§œ ë„˜ì–´ë„ OK)
  const k = getLocalDateKey(new Date()); // ì§€ê¸ˆ ì‹œì  ê¸°ì¤€
  const s = getStateForKey(k);
  s.fastingStartAt = sess.startAt;
  s.fastingEndAt   = end.toISOString();
  s.fastingMinutes = Math.max(0, Math.round(mins));
  saveStateForKey(k, s);

  // ì§„í–‰ ì„¸ì…˜ ì¢…ë£Œ
  clearFastSession();

  // í™”ë©´ì´ ì˜¤ëŠ˜ì´ë“  ê³¼ê±° í¸ì§‘ì´ë“ , "ì˜¤ëŠ˜ ê¸°ë¡"ì´ ì €ì¥ëœ ë’¤ í‘œì‹œ ê°±ì‹ 
  if(activeDateKey === todayKey){
    state = s;
  }
  update();
}

function cancelFasting(){
  const sess = loadFastSession();
  if(!sess || !sess.startAt){
    alert("ì·¨ì†Œí•  ì§„í–‰ ì¤‘ ë‹¨ì‹ì´ ì—†ì–´.");
    return;
  }

  if(!confirm("ì§„í–‰ ì¤‘ì¸ ë‹¨ì‹ë§Œ ì·¨ì†Œí• ê¹Œ? ê¸°ë¡ì—ëŠ” ë‚¨ì§€ ì•Šì•„.")) return;

  clearFastSession();
  update();
}

function deleteFastingRecord(){
  if(!state.fastingEndAt){
    alert("ì‚­ì œí•  ë‹¨ì‹ ê¸°ë¡ì´ ì—†ì–´.");
    return;
  }

  if(!confirm("ì´ ë‚ ì§œì˜ ë‹¨ì‹ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ì–´.")) return;

  state.fastingStartAt = null;
  state.fastingEndAt   = null;
  state.fastingMinutes = null;

  // êµ¬ë²„ì „ í•„ë“œ ì •ë¦¬ (ìˆì„ ê²½ìš°ë§Œ)
  if("fastingStart" in state) state.fastingStart = null;

  saveStateForKey(activeDateKey, state);
  update();
}


function renderFasting(){
  const delBtn = document.getElementById("deleteFastingBtn");
  const el = document.getElementById("fastText");
  if(!el) return;

  const sess = loadFastSession();

  // 1) ì§„í–‰ ì¤‘ ì„¸ì…˜ì´ ìˆìœ¼ë©´: ë‚ ì§œ ë„˜ì–´ë„ ê³„ì† í‘œì‹œ
  if(sess && sess.startAt){
    const start = new Date(sess.startAt);
    const end = new Date(start.getTime() + FAST_HOURS*60*60*1000);
    const now = new Date();

    if(now >= end){
      el.innerHTML = `â›” ${FAST_HOURS}ì‹œê°„ ë‹¨ì‹ (ì‹ì‚¬ ê°€ëŠ¥: <span class="good">${fmtHM(end)}</span>)`;
    }else{
      const ms = end - now;
      const h = Math.floor(ms/(60*60*1000));
      const m = Math.floor((ms%(60*60*1000))/(60*1000));
      el.innerHTML = `â›” ${FAST_HOURS}ì‹œê°„ ë‹¨ì‹ (ì‹ì‚¬ ê°€ëŠ¥: <span class="need">${fmtHM(end)}</span> / ë‚¨ì€ ${h}ì‹œê°„ ${m}ë¶„)`;
    }
    return;
  }

  // 2) ì§„í–‰ ì¤‘ì´ ì•„ë‹ˆë©´: ì˜¤ëŠ˜(ì„ íƒëœ ë‚ ì§œ)ì˜ ì™„ë£Œ ê¸°ë¡ í‘œì‹œ
  if(state.fastingEndAt && typeof state.fastingMinutes === "number"){
    const endAt = new Date(state.fastingEndAt);
    el.innerHTML = `âœ… ë‹¨ì‹ ì¢…ë£Œ <span class="good">${fmtHM(endAt)}</span> Â· ğŸ•’ ì‹¤ì œ ë‹¨ì‹ ${fmtDuration(state.fastingMinutes)}`;

    if(delBtn) delBtn.style.display = "inline-block";
    return;
  }

  // 3) ê·¸ ì™¸: ì‹œì‘ ì•ˆ í•¨
  el.innerHTML = `â›” ${FAST_HOURS}ì‹œê°„ ë‹¨ì‹ (ì‹œì‘ ì „)`;
  if(delBtn) delBtn.style.display = "none";

}

/* =========================
   ìˆ˜ë©´ íŠ¸ë˜í‚¹
========================= */

function startSleep(){
  const sess = loadSleepSession();
  if(sess && sess.startAt){
    if(!confirm("ì´ë¯¸ ì·¨ì¹¨ ê¸°ë¡ì´ ìˆì–´. ìƒˆë¡œ ì‹œì‘í• ê¹Œ?")) return;
  }
  saveSleepSession({ startAt: new Date().toISOString() });
  update();
}

function endSleep(){
  const sess = loadSleepSession();
  if(!sess || !sess.startAt){
    alert("ì·¨ì¹¨ ê¸°ë¡ì´ ì—†ì–´.");
    return;
  }

  const start = new Date(sess.startAt);
  const end   = new Date();
  const mins  = Math.max(0, Math.round((end - start) / 60000));

  // âœ… ê¸°ìƒ ì‹œì  ë‚ ì§œì— ì €ì¥
  const k = getLocalDateKey(end);
  const s = getStateForKey(k);

  s.sleepStartAt = sess.startAt;
  s.sleepEndAt   = end.toISOString();
  s.sleepMinutes = mins;

  saveStateForKey(k, s);
  clearSleepSession();

  if(activeDateKey === k) state = s;
  update();
}

function cancelSleep(){
  if(!confirm("ì§„í–‰ ì¤‘ì¸ ì·¨ì¹¨ ê¸°ë¡ë§Œ ì·¨ì†Œí• ê¹Œ?")) return;
  clearSleepSession();
  update();
}

function renderSleep(){
  const el = document.getElementById("sleepText");
  if(!el) return;

  const sess = loadSleepSession();

  // 1) ì·¨ì¹¨ ì¤‘
  if(sess && sess.startAt){
    const start = new Date(sess.startAt);
    el.innerHTML = `ğŸŒ™ ì·¨ì¹¨ ì¤‘ (${fmtHM(start)})`;
    return;
  }

  // 2) ê¸°ìƒ ì™„ë£Œ ê¸°ë¡
  if(state.sleepEndAt && typeof state.sleepMinutes === "number"){
    const h = Math.floor(state.sleepMinutes / 60);
    const m = state.sleepMinutes % 60;
    el.innerHTML = `ğŸ˜´ ìˆ˜ë©´ ${h}ì‹œê°„ ${m}ë¶„`;
    return;
  }

  // 3) ê¸°ë¡ ì—†ìŒ
  el.innerHTML = "ğŸ˜´ ìˆ˜ë©´ ê¸°ë¡ ì—†ìŒ";
}

/* =========================
   ë‹¨ë°±ì§ˆ íŠ¸ë˜í‚¹
========================= */
function addProtein(delta){
  const next = Math.max(0, (state.proteinG||0) + delta);
  state.proteinG = next;
  save(); update();
}
function resetProtein(){
  state.proteinG = 0;
  save(); update();
}
function renderProtein(){
  const g = state.proteinG || 0;
  const target = getProteinTarget(state.mode || "base");
  const left = Math.max(0, target - g);
  const ok = g >= target;

  const capMsg = (g > PROTEIN_SOFT_CAP)
    ? ` Â· <span class="need">ìƒí•œ ${PROTEIN_SOFT_CAP}gâ†‘</span>`
    : "";

  document.getElementById("proteinTrackText").innerHTML =
    ok
    ? `ğŸ¥© ë‹¨ë°±ì§ˆ <span class="good">${g}g</span> (âœ… ìµœì†Œ ${target}g ë‹¬ì„±${capMsg})`
    : `ğŸ¥© ë‹¨ë°±ì§ˆ <span class="need">${g}g</span> (ë‚¨ì€ ${left}g / ìµœì†Œ ${target}g${capMsg})`;

  // ì† ë¶ˆí¸ ë°©ì§€ìš© ì•„ì£¼ ì§§ì€ ì•ˆë‚´(ì²´í¬ í•­ëª© ì•„ë‹˜)
  const hintEl = document.getElementById("proteinHint");
  if(hintEl){
    hintEl.innerText = `TIP: ë‹¨ë°±ì§ˆë§Œ ëª°ì•„ë¨¹ìœ¼ë©´ ì†ì´ ë¶ˆí¸í•  ìˆ˜ ìˆì–´. ë‹¨ë°±ì§ˆ ì˜¬ë¦´ ë• ë°¥/ê³¼ì¼/ê²¬ê³¼ì²˜ëŸ¼ í•œ ì… ê°™ì´. (ê¶Œì¥ ìƒí•œ ${PROTEIN_SOFT_CAP}g)`;
  }
}

/* =========================
   ë¬¼ íŠ¸ë˜í‚¹
========================= */
function addWater(delta){
  const next = Math.max(0, (state.waterMl||0) + delta);
  state.waterMl = next;
  save(); update();
}
function resetWater(){
  state.waterMl = 0;
  save(); update();
}
function renderWater(){
  const ml = state.waterMl || 0;
  const left = Math.max(0, WATER_TARGET - ml);
  const cups = Math.floor(ml / WATER_UNIT);
  const ok = ml >= WATER_TARGET;

  document.getElementById("waterText").innerHTML =
    ok
    ? `ğŸ’§ ë¬¼ <span class="good">${ml}ml</span> (âœ… ëª©í‘œ ${WATER_TARGET}ml ë‹¬ì„±)`
    : `ğŸ’§ ë¬¼ <span class="need">${ml}ml</span> (ë‚¨ì€ ${left}ml / ${cups}íšŒ)`;
}

/* =========================
   ì²´í¬ë¦¬ìŠ¤íŠ¸
========================= */

const WEEKLY_WORKOUTS = {
  0: ["ğŸª½ ë“±"],                 // ì¼ìš”ì¼
  1: ["ğŸ”¥ ë³µë¶€", "ğŸ‘¯ í´"],       // ì›”ìš”ì¼
  2: ["ğŸ‘ í™", "ğŸ¦µ í¼ë¡¤ëŸ¬"],     // í™”ìš”ì¼
  3: ["ğŸª½ ë“±", "ğŸ‘¯ í´"],         // ìˆ˜ìš”ì¼
  4: ["ğŸ”¥ ë³µë¶€", "ğŸ’ª í¼ë¡¤ëŸ¬"],   // ëª©ìš”ì¼
  5: ["ğŸ‘ í™", "ğŸ‘¯ í™ˆí´ë§"],     // ê¸ˆìš”ì¼
  6: ["ğŸ‘¯ í´"]                  // í† ìš”ì¼
};

function renderChecklist(){
  const box = document.getElementById("checklist");
  if(!box) return;
  box.innerHTML = "";

  let list = MODES[state.mode] || BASE_ITEMS;

  // ìš´ë™ í•­ëª© ì¹˜í™˜
  list = list.filter(item => item.c !== "ìš´ë™");
  list = list.concat(getWorkoutChecklistItems());

  // âœ… ì—¬ê¸°ì„œë¶€í„° êµì²´ëœ ì½”ë“œ
  let lastCategory = null;
  let categoryBox = null;

  list.forEach(item => {

    if(item.c !== lastCategory){
      categoryBox = document.createElement("div");
      categoryBox.className = "section";
      box.appendChild(categoryBox);

      const h = document.createElement("div");
      h.className = "sectionTitle";
      h.innerText = item.c;
      categoryBox.appendChild(h);

      lastCategory = item.c;
    }

    const key = `${item.c}_${item.t}`;
    const checked = !!state.checks[key];

    const label = document.createElement("label");
    label.className = "checkItem";
    label.innerHTML = `
      <input type="checkbox" ${checked ? "checked" : ""}>
      <span>${item.t}</span>
    `;

    label.querySelector("input").addEventListener("change", e => {
      state.checks[key] = e.target.checked;
      saveStateForKey(activeDateKey, state);
    });

    categoryBox.appendChild(label);
  });
}

function getWorkoutChecklistItems(){

  // ğŸ‘‰ ê¸°ë³¸ ëª¨ë“œê°€ ì•„ë‹ˆë©´ ìš´ë™ ìƒì„± ìì²´ ì•ˆ í•¨
  if(state.mode !== "base") return [];

  const day = new Date(activeDateKey).getDay();
  const workouts = WEEKLY_WORKOUTS[day] || [];

  return workouts.map(text => ({
    c: "ìš´ë™",
    t: text,
    w: 2
  }));
}


/* =========================
   ë‚ ì§œ ë¶ˆëŸ¬ì˜¤ê¸°(ê³¼ê±°ë§Œ)
========================= */
function loadDate(){
  const d = document.getElementById("datePicker").value;
  if(!d) return alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì¤˜");
  if(d > todayKey) return alert("ë¯¸ë˜ ë‚ ì§œëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ì–´.");

  activeDateKey = d;
  state = JSON.parse(localStorage.getItem(activeDateKey))
    || {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStartAt:null,fastingEndAt:null,fastingMinutes:null};
  normalizeState();

  document.getElementById("today").innerText = activeDateKey + " (ìˆ˜ì •ì¤‘)";
  document.getElementById("editHint").style.display = "block";

  render();
}

function backToToday(){
  activeDateKey = todayKey;
  state = JSON.parse(localStorage.getItem(activeDateKey))
    || {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStartAt:null,fastingEndAt:null,fastingMinutes:null};
  normalizeState();

  document.getElementById("today").innerText = todayKey;
  document.getElementById("editHint").style.display = "none";

  render();
}

/* =========================
   íŒì • ê³„ì‚°
========================= */
function verdictFromRatio(ratio){
  if(ratio>=0.55) return {key:"pass", cls:"ok", txt:"í•©ê²©"};
  if(ratio>=0.30) return {key:"mid", cls:"midb", txt:"ë³´í†µ"};
  return {key:"rest", cls:"restb", txt:"íšŒë³µ"};
}

function calcWorkoutScore(s){
  const day = new Date(activeDateKey).getDay();
  const workouts = WEEKLY_WORKOUTS[day] || [];
  if(workouts.length === 0) return 0;

  let checked = 0;
  workouts.forEach(text => {
    const key = `ìš´ë™_${text}`;
    if(s.checks && s.checks[key]) checked++;
  });

  const perItem = 0.5;
  return Math.min(checked * perItem, 1);
}

function calcFreedivingScore(s){
  const key = "ìš´ë™_ğŸ¥½ í”„ë¦¬ë‹¤ì´ë¹™";
  return (s.checks && s.checks[key]) ? 1 : 0;
}

function calcStats(s){
  const mode = s.mode || "base";
let score = 0;
let total = 0;

// âœ… ê¸°ë³¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì ìˆ˜
const baseList = MODES[mode] || BASE_ITEMS;
baseList.forEach(it => {
  if(it.w > 0){
    total += it.w;
    const key = `${it.c}_${it.t}`;
    if(s.checks && s.checks[key]) score += it.w;
  }
});
  const proteinG = s.proteinG || 0;
  const waterMl  = s.waterMl  || 0;
  const fasting  = s.fastingEndAt ? 1 : 0;

// ë‹¨ë°±ì§ˆ
const proteinTarget = getProteinTarget(mode);
total += 2;
if(proteinG >= proteinTarget) score += 2;

// ë¬¼
total += 1;
if(waterMl >= WATER_TARGET) score += 1;

// ë‹¨ì‹
total += 1;
if(fasting) score += 1;

// âœ… ìš”ì¼ë³„ ìš´ë™ (ìµœëŒ€ 1ì )
total += 1;
score += calcWorkoutScore(s);

// âœ… í”„ë¦¬ë‹¤ì´ë¹™ (+1ì )
total += 1;
score += calcFreedivingScore(s);


  const ratio = total ? (score / total) : 0;
  return { mode, score, total, ratio, proteinG, waterMl };
}


/* =========================
   ì—…ë°ì´íŠ¸/ì´ˆê¸°í™”
========================= */
function update(){
  renderFasting();
  renderSleep();
  renderProtein();
  renderWater();
  renderChecklist();
  renderWeek();

  const st = calcStats(state);
  const r=document.getElementById("result");
  const v = verdictFromRatio(st.ratio);

  if(v.key==="pass"){ r.innerText="ì˜¤ëŠ˜ í•©ê²© âœ…"; r.className="result pass"; }
  else if(v.key==="mid"){ r.innerText="ë³´í†µ ğŸ™‚"; r.className="result mid"; }
  else { r.innerText="íšŒë³µ ë°ì´ ğŸŒ±"; r.className="result rest"; }
}

function resetToday(){
  if(confirm("í˜„ì¬ ì„ íƒëœ ë‚ ì§œì˜ ì²´í¬ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")){
    state = {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStartAt:null,fastingEndAt:null,fastingMinutes:null};
    save(); render();
  }
}

/* =========================
   íƒ­/ìš”ì•½
========================= */
function showTab(t){
  tabToday.classList.toggle("active", t==="today");
  tabWeek.classList.toggle("active", t==="week");
  tabAll.classList.toggle("active", t==="all");

  viewToday.classList.toggle("hide", t!=="today");
  viewWeek.classList.toggle("hide", t!=="week");
  viewAll_v2.classList.toggle("hide", t!=="all");


  if(t==="week") renderWeek();
  if(t==="all") renderAll_v2();
}

function renderWeek(){
  const body = document.getElementById("weekTable");
  body.innerHTML = "";

  let pass=0, mid=0, rest=0;

  for(let i=6;i>=0;i--){
    const d = new Date();
    d.setDate(d.getDate()-i);
    const k = getLocalDateKey(d);
    const s = getStateForKey(k);

    if(!s) continue;

    const st = calcStats(s);
    const v  = verdictFromRatio(st.ratio);

    if(v.key==="pass") pass++;
    else if(v.key==="mid") mid++;
    else rest++;

    // ë‹¨ë°±ì§ˆ
    const protein = s.proteinG ? `${s.proteinG}g` : "-";

    // ë¬¼
    const water = s.waterMl ? `${(s.waterMl/1000).toFixed(1)}L` : "-";

    // ë‹¨ì‹
    let fasting = "-";
    if(s.fastingMinutes){
      const h = Math.floor(s.fastingMinutes/60);
      const m = s.fastingMinutes%60;
      fasting = `${h}:${String(m).padStart(2,"0")}`;
    }

    // ìˆ˜ë©´
    let sleep = "-";
    if(s.sleepMinutes){
      const h = Math.floor(s.sleepMinutes/60);
      const m = s.sleepMinutes%60;
      sleep = `${h}:${String(m).padStart(2,"0")}`;
    }

    body.innerHTML += `
      <tr>
        <td>${k}</td>
        <td>${modeLabel(st.mode)}</td>
        <td><span class="badge ${v.cls}">${v.txt}</span></td>
        <td class="mono">${protein}</td>
        <td class="mono">${water}</td>
        <td class="mono">${fasting}</td>
        <td class="mono">${sleep}</td>
      </tr>`;
  }

  document.getElementById("weekSummary").innerText =
    `í•©ê²© ${pass}ì¼ Â· ë³´í†µ ${mid}ì¼ Â· íšŒë³µ ${rest}ì¼`;
}


/* ===== ALL: group by month + filters ===== */
const dateRe = /^\d{4}-\d{2}-\d{2}$/;

function getAllKeys(){
  const keys=[];
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(dateRe.test(k)) keys.push(k);
  }
  keys.sort((a,b)=> b.localeCompare(a));
  return keys;
}

function renderAll_v2(){
  const modeF = document.getElementById("allModeFilter_v2")?.value || "all";
  const verF  = document.getElementById("allVerdictFilter_v2")?.value || "all";

  const summary = document.getElementById("allSummary_v2");
  const container = document.getElementById("viewAll_v2");
  if(!summary || !container) return;

  // ê¸°ì¡´ ì›”ë³„ ë¦¬ìŠ¤íŠ¸ ì œê±° (ìš”ì•½/í•„í„°ëŠ” ìœ ì§€)
  container.querySelectorAll("details").forEach(el => el.remove());
  container.querySelectorAll(".emptyMsg").forEach(el => el.remove());

  const keys = getAllKeys();
  const groups = {}; // { YYYY-MM: [...] }
  let total=0, pass=0, mid=0, rest=0;

  keys.forEach(k=>{
    const s = getStateForKey(k);
    if(!s) return;

    const st = calcStats(s);
    const v  = verdictFromRatio(st.ratio);

    // âœ… í•„í„°ëŠ” ì—¬ê¸°ì„œ!
    if(modeF !== "all" && (st.mode || "base") !== modeF) return;
    if(verF  !== "all" && v.key !== verF) return;

    total++;
    if(v.key==="pass") pass++;
    else if(v.key==="mid") mid++;
    else rest++;

    const ym = k.slice(0,7);
    groups[ym] = groups[ym] || [];

    const protein = s.proteinG ? `${s.proteinG}g` : "-";
    const water   = s.waterMl ? `${(s.waterMl/1000).toFixed(1)}L` : "-";

    let fasting = "-";
    if(s.fastingMinutes){
      const h = Math.floor(s.fastingMinutes/60);
      const m = s.fastingMinutes % 60;
      fasting = `${h}:${String(m).padStart(2,"0")}`;
    }

    let sleep = "-";
    if(s.sleepMinutes){
      const h = Math.floor(s.sleepMinutes/60);
      const m = s.sleepMinutes % 60;
      sleep = `${h}:${String(m).padStart(2,"0")}`;
    }

    groups[ym].push({
      date:k,
      mode:st.mode,
      verdict:v,
      protein, water, fasting, sleep
    });
  });

  summary.innerText = `ì´ ${total}ì¼ Â· í•©ê²© ${pass} Â· ë³´í†µ ${mid} Â· íšŒë³µ ${rest}`;

  const months = Object.keys(groups).sort((a,b)=> b.localeCompare(a));
  if(months.length === 0){
    container.insertAdjacentHTML(
      "beforeend",
      `<div class="section emptyMsg"><div class="small">ê¸°ë¡ì´ ì—†ì–´.</div></div>`
    );
    return;
  }

  months.forEach((ym, idx)=>{
    const rows = groups[ym];

    let mp=0, mm=0, mr=0;
    rows.forEach(r=>{
      if(r.verdict.key==="pass") mp++;
      else if(r.verdict.key==="mid") mm++;
      else mr++;
    });

    const det = document.createElement("details");
    if(idx===0) det.open = true;

    det.innerHTML = `
      <summary>
        <div class="summaryRow">
          <div>${ym} <span class="small">(í•©ê²© ${mp} Â· ë³´í†µ ${mm} Â· íšŒë³µ ${mr})</span></div>
          <div class="small">ëˆŒëŸ¬ì„œ í¼ì¹˜ê¸°</div>
        </div>
      </summary>
      <div style="overflow:auto; margin-top:8px;">
        <table>
          <thead>
            <tr>
              <th>ë‚ ì§œ</th>
              <th>ëª¨ë“œ</th>
              <th>íŒì •</th>
              <th>ë‹¨ë°±ì§ˆ</th>
              <th>ë¬¼</th>
              <th>ë‹¨ì‹</th>
              <th>ìˆ˜ë©´</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td>${r.date}</td>
                <td>${modeLabel(r.mode)}</td>
                <td><span class="badge ${r.verdict.cls}">${r.verdict.txt}</span></td>
                <td class="mono">${r.protein}</td>
                <td class="mono">${r.water}</td>
                <td class="mono">${r.fasting}</td>
                <td class="mono">${r.sleep}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `;
    container.appendChild(det);
  });
}

document.getElementById("allModeFilter_v2").onchange = renderAll_v2;
document.getElementById("allVerdictFilter_v2").onchange = renderAll_v2;

/* =========================
   init + ë‹¨ì‹ í…ìŠ¤íŠ¸ ì£¼ê¸° ê°±ì‹ 
========================= */
render();
setInterval(()=>{ renderFasting(); }, 60*1000);

// PWA
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{ navigator.serviceWorker.register("./sw.js").catch(()=>{}); });
}
</script>

</body>
</html>
