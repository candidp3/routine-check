<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸë£¨í‹´ ì²´í¬</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#222222">

<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f6f6f6;margin:0;padding:14px;color:#222}
h1{text-align:center;margin:6px 0}
.small{font-size:13px;color:#666}
.tabs,.modes{display:flex;gap:8px;margin:12px 0}
.tab,.mode{flex:1;padding:10px;border-radius:12px;border:none;background:#e6e6e6;font-size:14px}
.tab.active,.mode.on{background:#cfcfcf;font-weight:700}
.section{background:#fff;border-radius:14px;padding:12px;margin-bottom:10px}
.section h2{margin:0 0 8px;font-size:16px}
label{display:flex;align-items:center;gap:8px;padding:6px 0}
input[type=checkbox]{width:18px;height:18px}
.result{text-align:center;font-size:20px;font-weight:800;margin:14px 0}
.pass{color:#1fa16f}.mid{color:#2494bd}.rest{color:#facc00}
.btn{width:100%;padding:10px;border-radius:12px;border:none;background:#e6e6e6;font-size:14px}
.btn:active{background:#cfcfcf}
.hide{display:none}

table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eee;font-size:13px}
th{text-align:left;color:#666}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
.ok{background:#e7f6ea;color:#2e7d32}
.midb{background:#fff4d6;color:#f9a825}
.restb{background:#fde7e7;color:#c62828}

.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,.textin{
  padding:8px 10px;border-radius:10px;border:1px solid #ddd;background:#fff;font-size:14px;
}
.textin{min-width:160px}
details{background:#fff;border-radius:14px;padding:10px 12px;margin-bottom:10px}
details > summary{cursor:pointer;font-weight:800;list-style:none}
details > summary::-webkit-details-marker{display:none}
.summaryRow{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
.mono{font-variant-numeric:tabular-nums}

/* ===== ëª¨ë°”ì¼ í‘œ ì¤„ë°”ê¿ˆ ì™„ì „ ì°¨ë‹¨ + ê¸€ì ì¶•ì†Œ + ì—´ ìµœì†Œí­ ===== */
table{table-layout:auto;width:max-content;min-width:100%}
th, td{
  white-space:nowrap !important;
  word-break:keep-all !important;
  text-align:center;
  vertical-align:middle;
}
.badge{white-space:nowrap;display:inline-block}
th:nth-child(2), td:nth-child(2){ min-width:70px; } /* ëª¨ë“œ */
th:nth-child(4), td:nth-child(4){ min-width:60px; } /* íŒì • */
th:nth-child(5), td:nth-child(5){ min-width:70px; } /* ë‹¨ë°±ì§ˆ */
th:nth-child(6), td:nth-child(6){ min-width:70px; } /* ë¬¼ */
@media (max-width:420px){
  th, td{ font-size:12px; padding:6px 8px; }
  .tab, .mode{ font-size:13px; padding:9px; }
}

/* ===== BONUS ë°°ì§€ ===== */
.bonusTag{
  margin-left:8px;
  font-size:10px;
  padding:2px 8px;
  border-radius:999px;
  background:#f1f1f1;
  color:#777;
  font-weight:700;
}

/* ===== íŠ¸ë˜ì»¤ UI ===== */

.trackRow{
  display:flex;
  align-items:flex-start;
  gap:12px;
  padding:6px 0;
}

.trackBtns{
  margin-left:auto;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  justify-content:flex-end;
}

.trackBtns button{
  border:none;
  border-radius:10px;
  padding:6px 8px;
  background:#e6e6e6;
  font-size:13px;
}
.trackBtns button:active{background:#cfcfcf}
.trackStat{font-size:13px;color:#444}
.good{font-weight:800;color:#2e7d32}
.need{font-weight:800;color:#c62828}
.hint{font-size:12px;color:#777;margin-top:6px;line-height:1.35}

.trackBtns button.reset{
  background:#f1f1f1;
  font-size:11px;
  opacity:0.7;
}
  
/* ===== ë‚ ì§œ ì„ íƒ í•œ ì¤„ ì •ë ¬ ===== */
.dateRow{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:nowrap;   /* ì ˆëŒ€ ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
}

.dateTitle{
  font-size:13px;
  color:#666;
  white-space:nowrap;
}

#datePicker{
  width:140px;        /* âœ… ë‚ ì§œ ë°•ìŠ¤ ê³ ì • í­ (ì›í•˜ë©´ 140~170 ì¡°ì ˆ) */
  padding:6px 10px;
  border-radius:10px;
  border:1px solid #ddd;
  background:#fff;
  font-size:14px;
}

.dateBtn{
  padding:6px 10px;
  border-radius:12px;
  border:none;
  background:#e6e6e6;
  font-size:12px;
  white-space:nowrap;
}

.dateBtn:active{ background:#cfcfcf; }

/* ===== ë‹¨ì‹ ì „ìš© ì •ë ¬ ===== */
.fastText{
  white-space:nowrap;      /* ë¬¸êµ¬ í•œ ì¤„ */
  overflow:hidden;
  text-overflow:ellipsis; /* ë„ˆë¬´ ê¸¸ë©´ ... */
}

.fastBtns{
  width:100%;
  display:flex;
  justify-content:flex-end; /* ë²„íŠ¼ ì˜¤ë¥¸ìª½ ì •ë ¬ */
  gap:6px;
  margin-top:4px;
  flex-wrap:nowrap;        /* ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
}

.fastBtns button{
  white-space:nowrap;     /* ê¸€ì”¨ ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
  flex-shrink:0;          /* ë²„íŠ¼ ì°Œê·¸ëŸ¬ì§€ì§€ ì•Šê²Œ */
}

/* ===== ë‹¨ë°±ì§ˆ ì „ìš© ì •ë ¬ ===== */
  
.proteinBtn{
  width:65px;          /* âœ… ë„‘ì´ ê°•ì œ ê³ ì • */
  height:27px;          /* âœ… ë†’ì´ ê°•ì œ ê³ ì • */
  padding:0;
  font-size:12px;
  text-align:center;
    line-height:1;
}
.fastBtns.proteinBtns{
  flex-wrap:wrap;   /* ë‹¨ë°±ì§ˆë§Œ ì¤„ë°”ê¿ˆ í—ˆìš© */
}
  
#deleteFastingBtn{
  padding:4px 6px;
  font-size:11px;
  opacity:0.6;
}
#deleteFastingBtn:hover{
  opacity:1;
}

/* ì²´í¬ë¦¬ìŠ¤íŠ¸ ì „ìš© ê¸€ì”¨ í¬ê¸° ë³µêµ¬ */
.checkItem{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:15px;   /* â† ì´ì „ í¬ê¸°ë¡œ */
  color:#222;
  margin:6px 0;
}

.sectionTitle{
  font-weight:700;
  font-size:14px;
  margin-bottom:6px;
}

.checkItem input[type="checkbox"]{
  width:15px;
  height:15px;
  transform: scale(0.9);
}

@media (max-width: 480px){
  .trackBtns button{
    padding:5px 7px;
    font-size:11px;
  }
}

/* ===== ì‹ë‹¨ ì¶”ì²œ ===== */
.mealItem{
  display:grid;
  grid-template-columns: 1fr auto auto;
  gap:8px;
  padding:6px 0;
  align-items:center;
  font-size:14px;
}
.mealItem .protein{
  font-weight:700;
  color:#2e7d32;
}
.optionCard{
  background:#f7f7f7;
  border-radius:10px;
  padding:8px;
  margin-top:8px;
}
.optionTitle{
  font-size:12px;
  font-weight:700;
  color:#666;
  margin-bottom:4px;
}

</style>
</head>

<body>

<h1>ğŸ ë£¨í‹´ ì²´í¬</h1>
<div class="small" style="text-align:center" id="today"></div>

<!-- FIRST ROW : MODE -->
<div class="tabs">
  <button class="tab active" id="tabToday" onclick="showTab('today'); setMode('base')">â™¥ï¸ ê¸°ë¡</button>
  <button class="tab" id="mHard" onclick="setMode('hard')">ğŸ«  í˜ë“  ë‚ </button>
  <button class="tab" id="mTravel" onclick="setMode('travel')">âœˆï¸ ì—¬í–‰/ì¼íƒˆ</button>
</div>
  
<!-- SECOND ROW : PAGES -->
<div class="tabs">
  <button class="tab" id="tabMeal" onclick="showTab('meal')">ğŸ½ï¸ ì‹ë‹¨ ì¶”ì²œ</button>
  <button class="tab" id="tabAll" onclick="showTab('all')">ğŸ“š ì „ì²´ ê¸°ë¡</button>
  <button class="tab" id="tabBackup" onclick="showTab('backup')">ğŸ” ë°±ì—…</button>
</div>  
  
<!-- TODAY -->
<div id="viewToday">

  <!-- ê³¼ê±° ê¸°ë¡ ìˆ˜ì • -->
  <div class="section">
    <div class="dateRow">
      <div class="dateTitle">ğŸ“…</div>
  
      <input type="date" id="datePicker">
  
      <button class="dateBtn" onclick="loadDate()">í™•ì¸</button>
      <button class="dateBtn" onclick="backToToday()">ğŸ¦– ì˜¤ëŠ˜</button>
    </div>
  
    <div class="small" id="editHint" style="margin-top:6px;color:#c62828;display:none;">
      âš ï¸ ê³¼ê±° ê¸°ë¡ ìˆ˜ì • ì¤‘
    </div>
  </div>

  <!-- ë‹¨ì‹/ë‹¨ë°±ì§ˆ/ë¬¼/ìˆ˜ë©´ íŠ¸ë˜ì»¤ -->
  <div class="section">

    <div class="trackRow" style="flex-direction:column;">
    <div class="trackStat fastText" id="fastText"></div>
  
    <div class="trackBtns fastBtns">
      <button class="reset" onclick="cancelFasting()">Reset</button>
      <button onclick="startFasting()">â›” ì‹œì‘</button>
      <button onclick="endFasting()">âœ… ì¢…ë£Œ</button>
      <button onclick="manualFasting()">â±</button>
      <button id="deleteFastingBtn"
              class="reset"
              onclick="deleteFastingRecord()"
              style="display:none"
              >ğŸ—‘</button>
    </div>
  </div>

    <div class="hint" id="proteinHint"></div>

    <div class="trackRow" style="flex-direction:column;">
      <div class="trackStat fastText" id="proteinTrackText"></div>
    
      <div class="trackBtns fastBtns proteinBtns">
        <button class="reset" onclick="resetProtein()">Reset</button>    
        <button class="proteinBtn" onclick="addProtein(-10)">â†©ï¸ -10g</button>
        <button class="proteinBtn" onclick="addProtein(-5)">â†©ï¸ -5g</button>
        <!-- âœ… ì—¬ê¸° ì¤„ë°”ê¿ˆ -->
        <div style="flex-basis:100%;height:0"></div>

        <button class="proteinBtn" onclick="addProtein(1)">ğŸ£ +1g</button>        
        <button class="proteinBtn" onclick="addProtein(5)">ğŸ¥š +5g</button>
        <button class="proteinBtn" onclick="addProtein(10)">ğŸ— +10g</button>
        <button class="proteinBtn" onclick="addProtein(20)">ğŸ¥© +20g</button>
      </div>
    </div>

    <div class="trackRow" style="flex-direction:column;">
      <div class="trackStat fastText" id="waterText"></div>
    
      <div class="trackBtns fastBtns">
        <button class="reset" onclick="resetWater()">Reset</button>
        <button onclick="addWater(-WATER_UNIT)">â†©ï¸ -120ml</button>
        <button onclick="addWater(WATER_UNIT)">ğŸ’§ +120ml</button>
      </div>
    </div>

    <div class="trackRow" style="flex-direction:column;">
      <div class="trackStat fastText" id="sleepText"></div>
    
      <div class="trackBtns fastBtns">
        <button class="reset" onclick="cancelSleep()">Reset</button>
        <button onclick="startSleep()">ğŸŒ™ ê¿€ì </button>
        <button onclick="endSleep()">â˜€ï¸ ì¸ë‚˜</button>
        <button onclick="manualSleep()">â±</button>
        <button id="deleteSleepBtn"
                class="reset"
                onclick="deleteSleepRecord()"
                style="display:none"
                >ğŸ—‘</button> 
      </div>
    </div>
  
  </div>

  <div id="checklist"></div>

  <div class="result" id="result">ì²´í¬ ì‹œì‘</div>

  <button class="btn" onclick="resetToday()">ì˜¤ëŠ˜ ì²´í¬ ì´ˆê¸°í™”</button>
</div>

<!-- ALL v2 -->
<div id="viewAll_v2" class="hide">
  <div class="section">
    <h2>ì „ì²´ ê¸°ë¡</h2>
    <div class="controls" style="margin-top:8px">
      <select id="allModeFilter_v2">
        <option value="all">ëª¨ë“œ: ì „ì²´</option>
        <option value="base">â™¥ï¸ ê¸°ë³¸</option>
        <option value="hard">ğŸ«  í˜ë“  ë‚ </option>
        <option value="travel">âœˆï¸ ì—¬í–‰/ì¼íƒˆ</option>
      </select>
    
      <select id="allVerdictFilter_v2">
        <option value="all">íŒì •: ì „ì²´</option>
        <option value="pass">í•©ê²©</option>
        <option value="mid">ë³´í†µ</option>
        <option value="rest">íšŒë³µ</option>
      </select>
    </div>

    <div class="small" id="allSummary_v2"></div>
  </div>
</div>

<!-- MEAL -->
<div id="viewMeal" class="hide">

  <!-- ê³µí†µ ë©”ì¸ ë‹¨ë°±ì§ˆ -->
  <div class="section">
    <h2>ğŸ¥© ë©”ì¸ ë‹¨ë°±ì§ˆ <span class="small">(ì ì‹¬Â·ì €ë… ê³µí†µ)</span></h2>
    <div class="small"><b>ì•„ë˜ ì¤‘ 1ê°€ì§€ ì„ íƒ</b></div>
  
    <div class="mealItem">
      <span>ğŸ— ë‹­ê°€ìŠ´ì‚´</span>
      <span class="mono">100g</span>
      <span class="protein">20g</span>
    </div>
    <div class="mealItem">
      <span>ğŸ¥© ëª©ì‚´êµ¬ì´</span>
      <span class="mono">100g</span>
      <span class="protein">20g</span>
    </div>
    <div class="mealItem">
      <span>ğŸŸ ìƒì„ êµ¬ì´</span>
      <span class="mono">100g</span>
      <span class="protein">20g</span>
    </div>
    
    <hr style="border:none;border-top:1px dashed #ddd;margin:10px 0">
    </div>
  
  <!-- ì ì‹¬ -->
  <div class="section">
    <h2>ğŸ½ï¸ ì ì‹¬ <span class="small">(11:00)</span></h2>
    <div class="small">
      ê¸°ë³¸ êµ¬ì„± + <b>ë©”ì¸ ë‹¨ë°±ì§ˆ 1ê°€ì§€ ì„ íƒ</b>
    </div>
  
    <div class="mealItem">
      <span>ğŸ¥š ë‹¬ê±€</span>
      <span class="mono">1ê°œ</span>
      <span class="protein">6g</span>
    </div>
    <div class="mealItem">
      <span>ğŸš í˜„ë¯¸ë°¥</span>
      <span class="mono">160g</span>
      <span class="protein">3g</span>
    </div>
    <div class="mealItem">
      <span>ğŸ¥— ì±„ì†Œ</span>
      <span class="mono">100g</span>
      <span class="protein">1g</span>
    </div>
    <div class="mealItem">
      <span>ğŸ«˜ ë‘ìœ </span>
      <span class="mono">190ml</span>
      <span class="protein">5g</span>
    </div>
  </div>


  <!-- ê°„ì‹ -->
  <div class="section">
    <h2>ğŸª ê°„ì‹ <span class="small">(16:30)</span></h2>

    <div class="optionCard">
      <div class="optionTitle">ì˜µì…˜ A</div>
      <div class="mealItem">
        <span>ğŸ¶ ë‹¨ë°±ì§ˆ ìŒë£Œ</span>
        <span class="mono">1íŒ©</span>
        <span class="protein">20g</span>
      </div>
    </div>

    <div class="optionCard">
      <div class="optionTitle">ì˜µì…˜ B</div>
      <div class="mealItem">
        <span>ğŸ« ë‹¨ë°±ì§ˆë°”</span>
        <span class="mono">1ê°œ</span>
        <span class="protein">20g</span>
      </div>
    </div>

    <div class="optionCard">
      <div class="optionTitle">ì˜µì…˜ C</div>
      <div class="mealItem">
        <span>ğŸ¯ ê·¸ë¦­ìš”ê±°íŠ¸</span>
        <span class="mono">80g</span>
        <span class="protein">9g</span>
      </div>
      <div class="mealItem">
        <span>ğŸ« ë‹¨ë°±ì§ˆë°”</span>
        <span class="mono">1/2ê°œ</span>
        <span class="protein">10g</span>
      </div>
      <div class="mealItem">
        <span>ğŸ ê³¼ì¼</span>
        <span class="mono">120g</span>
        <span class="protein">0g</span>
      </div>
    </div>

    <div class="optionCard">
      <div class="optionTitle">ì˜µì…˜ D</div>
      <div class="mealItem">
        <span>ğŸ¥› ë‹¨ë°±ì§ˆ ìš°ìœ </span>
        <span class="mono">200ml</span>
        <span class="protein">9g</span>
      </div>
      <div class="mealItem">
        <span>ğŸ¥œ ê·¸ë ˆë†€ë¼</span>
        <span class="mono">40g</span>
        <span class="protein">3g</span>
      </div>
      <div class="mealItem">
        <span>ğŸ¥¨ ë‹¨ë°±ì§ˆ ê³¼ì</span>
        <span class="mono">45ê°œ</span>
        <span class="protein">5g</span>
      </div>
    </div>
  </div>

  <!-- ì €ë… -->
  <div class="section">
    <h2>ğŸ½ï¸ ì €ë… <span class="small">(20:00)</span></h2>
    <div class="small">
      ê¸°ë³¸ êµ¬ì„± + <b>ë©”ì¸ ë‹¨ë°±ì§ˆ 1ê°€ì§€ ì„ íƒ</b>
    </div>
  
    <div class="mealItem">
      <span>ğŸš í˜„ë¯¸ë°¥</span>
      <span class="mono">100g</span>
      <span class="protein">2g</span>
    </div>
    <div class="mealItem">
      <span>ğŸ¥— ì±„ì†Œ</span>
      <span class="mono">100g</span>
      <span class="protein">1g</span>
    </div>
  </div>

  <!-- ì¹˜í™˜ ê¸°ì¤€ -->
  <details class="section">
    <summary>ğŸ” ì‹ë‹¨ ì¹˜í™˜ ê¸°ì¤€</summary>
    <div class="small" style="margin-top:8px;line-height:1.6">
      <b>ê³¡ë¬¼</b><br>
      â€¢ í˜„ë¯¸ë°¥ 160g = í†µë°€ëª¨ë‹ë¹µ 80g (ì•½ 2ê°œ)<br>
      â€¢ í˜„ë¯¸ë°¥ 100g = í†µë°€ëª¨ë‹ë¹µ 50g (1~1.5ê°œ)<br><br>

      <b>ì±„ì†Œ 100g ê¸°ì¤€</b><br>
      â€¢ ìƒì¶” 6ì¥ + ë°©ìš¸í† ë§ˆí†  6ê°œ<br>
      â€¢ ìƒì¶” 12ì¥<br>
      â€¢ ë°©ìš¸í† ë§ˆí†  12ê°œ<br>
      â€¢ ë³¶ìŒë°¥ìš© ì±„ì†Œ (ì¡°ë¦¬ ì „ 100g)
    </div>
  </details>
    
</div>
  
<!-- BACKUP -->
<div id="viewBackup" class="hide">
  <div class="section">
    <h2>ğŸ” ë°±ì—… Â· ë³µì›</h2>

    <button class="btn" onclick="exportBackup()">ğŸ“¦ ë°±ì—… ë³µì‚¬</button>

    <textarea
      id="backupInput"
      class="textin"
      placeholder="ì—¬ê¸°ì— ë°±ì—… JSON ë¶™ì—¬ë„£ê¸°"
      style="width:100%; height:120px; margin-top:8px;"
    ></textarea>

    <button class="btn" style="margin-top:6px;" onclick="importBackup()">
      â™»ï¸ ë³µì›í•˜ê¸°
    </button>

    <button class="btn" style="margin-top:6px;" onclick="restoreLatestAutoBackup()">
      â® ìë™ ë°±ì—…ìœ¼ë¡œ ë³µì›
    </button>
  </div>

  <div class="section">
    <div class="small">
      â€¢ ìë™ ë°±ì—…: ì•± ì‹¤í–‰ ì‹œì™€ ë‚ ì§œ ë³€ê²½ ì‹œ ìë™ ì €ì¥ë¨<br>
      â€¢ íœ´ëŒ€í° ë³€ê²½/ì•± ì‚­ì œ ëŒ€ë¹„ëŠ” ë°˜ë“œì‹œ "ğŸ“¦ë°±ì—… ë³µì‚¬" ì‚¬ìš©
    </div>
  </div>
</div>

<script>
  
/* =========================
   ë‚ ì§œ/ìƒíƒœ ê¸°ë³¸
========================= */
/* ===== ë¡œì»¬ ë‚ ì§œ í‚¤(UTC ì˜¤ì°¨ ë°©ì§€) ===== */
function getLocalDateKey(d=new Date()){
  // sv-SEëŠ” YYYY-MM-DD í¬ë§·ì„ ì•ˆì •ì ìœ¼ë¡œ ë°˜í™˜
  return d.toLocaleDateString('sv-SE');
}
const todayKey = getLocalDateKey(new Date());
document.getElementById("today").innerText = todayKey;
let activeDateKey = todayKey;

let lastBackupDate = getLocalDateKey(new Date());

setInterval(()=>{
  const nowKey = getLocalDateKey(new Date());
  if(nowKey !== lastBackupDate){
    lastBackupDate = nowKey;
    makeAutoBackup();
  }
}, 60 * 1000); // 1ë¶„ ì²´í¬

/* =========================
   ì„¤ì •ê°’
========================= */
const FAST_HOURS = 14;

/* ===== ë‹¨ì‹ ì„¸ì…˜(ë‚ ì§œë¥¼ ë„˜ì–´ ì´ì–´ì§€ê²Œ) =====
   - ì§„í–‰ ì¤‘ ë‹¨ì‹ì€ ë‚ ì§œ(state)ì™€ ë¶„ë¦¬í•´ì„œ ì €ì¥
   - ì¢…ë£Œ ì‹œ "ì˜¤ëŠ˜(todayKey)" ê¸°ë¡ìœ¼ë¡œ ì €ì¥
========================================== */
const FAST_SESSION_KEY = "__fastingSession_v1";
const SLEEP_SESSION_KEY = "sleep_session";

function loadFastSession(){
  try{
    return JSON.parse(localStorage.getItem(FAST_SESSION_KEY) || "null");
  }catch(e){ return null; }
}
function saveFastSession(obj){
  localStorage.setItem(FAST_SESSION_KEY, JSON.stringify(obj));
}
function clearFastSession(){
  localStorage.removeItem(FAST_SESSION_KEY);
}

function loadSleepSession(){
  return JSON.parse(localStorage.getItem(SLEEP_SESSION_KEY) || "null");
}
function saveSleepSession(v){
  localStorage.setItem(SLEEP_SESSION_KEY, JSON.stringify(v));
}
function clearSleepSession(){
  localStorage.removeItem(SLEEP_SESSION_KEY);
}

const WATER_UNIT = 120;
const WATER_TARGET = 2000;

// âœ… ë‹¨ë°±ì§ˆ: ëª¨ë“œë³„ ìµœì†Œì¹˜ + ì†Œí”„íŠ¸ ìƒí•œ(ê¶Œì¥)
const PROTEIN_TARGETS = { base: 58, hard: 40, travel: 45 };
const PROTEIN_SOFT_CAP = 100;
function getProteinTarget(mode){ return PROTEIN_TARGETS[mode] ?? 58; }

/* =========================
   ì²´í¬ë¦¬ìŠ¤íŠ¸ (ì‹œê°„+ë‚´ìš© í†µì¼)
========================= */
const BASE_ITEMS = [
  {c:"ì•„ì¹¨",t:"ğŸŒ 10ì‹œ ì „ í™œë™",w:1},
  {c:"ì•„ì¹¨",t:"ğŸª¥ ì–‘ì¹˜",w:1},
  {c:"ì•„ì¹¨",t:"ğŸ’Š ìœ ì‚°ê· ",w:1},


  {c:"ì ì‹¬",t:"ğŸ’Š ë¹„íƒ€ë¯¼",w:1},
  {c:"ì ì‹¬",t:"ğŸ‹ ë ˆëª¬ë¬¼",w:1},
  {c:"ì ì‹¬",t:"ğŸƒ í™˜ê¸°",w:1},
  {c:"ì ì‹¬",t:"ğŸ  ê°€ë²¼ìš´ í™œë™",w:2},


  {c:"ì €ë…",t:"ğŸª† ë¦¼í”„ ë§ˆì‚¬ì§€",w:2},
];

const MODES = {
  base: BASE_ITEMS,
  hard: [
    {c:"í•˜ë£¨",t:"ğŸ˜˜ ë”± 5ë¶„ë§Œ ì›€ì§ì´ì",w:2},
    {c:"í•˜ë£¨",t:"ğŸ  ì‹í›„ ê°€ë²¼ìš´ í™œë™",w:2},
  ],
  travel: [
    {c:"ì—¬í–‰",t:"ğŸ™ ìŠ¤íŠ¸ë ˆì¹­",w:2},
  ]
};

const modeLabel = (m) => {
  if(m==="hard") return "ğŸ«  í˜ë“  ë‚ ";
  if(m==="travel") return "âœˆï¸ ì—¬í–‰/ì¼íƒˆ";
  return "ê¸°ë³¸";
};

/* =========================
   state ë¡œë“œ/ë³´ì •
========================= */
let state = JSON.parse(localStorage.getItem(activeDateKey))
  || {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStartAt:null,fastingEndAt:null,fastingMinutes:null};

function normalizeState(){
  if(!state || typeof state!=="object") state = {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStartAt:null,fastingEndAt:null,fastingMinutes:null};
  if(!state.checks || typeof state.checks!=="object") state.checks = {};
  if(typeof state.waterMl !== "number") state.waterMl = 0;
  if(typeof state.proteinG !== "number") state.proteinG = 0;

  // âœ… êµ¬ë²„ì „ í˜¸í™˜: fastingStart â†’ fastingStartAt
  if(state.fastingStart && !state.fastingStartAt){
    state.fastingStartAt = state.fastingStart;
  }
  // í•„ë“œ ë³´ì •
  if(!("fastingStartAt" in state)) state.fastingStartAt = null;
  if(!("fastingEndAt" in state)) state.fastingEndAt = null;
  if(!("fastingMinutes" in state)) state.fastingMinutes = null;

  if(!state.mode) state.mode = "base";
}
normalizeState();

function save(){
  localStorage.setItem(activeDateKey, JSON.stringify(state));
}

/* =========================
   ëª¨ë“œ/ë Œë”
========================= */
function setMode(m){
  state.mode = (state.mode===m) ? "base" : m;
  save();
  render();
}

function render(){

  // ëª¨ë“œ ë²„íŠ¼ ì´ˆê¸°í™”
  ["mHard","mTravel"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove("active");
  });

  // í˜„ì¬ ëª¨ë“œ ê°•ì¡°
  if(state.mode === "hard") {
    document.getElementById("mHard")?.classList.add("active");
  } else if(state.mode === "travel") {
    document.getElementById("mTravel")?.classList.add("active");
  }
  // base ëª¨ë“œëŠ” 'ê¸°ë¡(tabToday)'ê°€ ì´ë¯¸ í™œì„±í™” ì—­í• 

  // datePicker ë³´ì •
  const dp = document.getElementById("datePicker");
  if(dp){
    dp.max = todayKey;
    dp.value = activeDateKey;
  }

  update(); // âœ… ì—¬ê¸°ê¹Œì§€ ì™€ì•¼ ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ ê·¸ë ¤ì§
}


/* =========================
   ë‹¨ì‹ íŠ¸ë˜í‚¹ (ì‹œì‘â†’ì¢…ë£Œ, ë‚ ì§œ ë„˜ì–´ ìœ ì§€)
========================= */
function fmtHM(d){
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}
function fmtDuration(mins){
  const m = Math.max(0, Math.round(mins));
  const h = Math.floor(m/60);
  const mm = m % 60;
  return `${h}ì‹œê°„ ${mm}ë¶„`;
}

function getStateForKey(k){
  const s = JSON.parse(localStorage.getItem(k) || "null")
    || {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStartAt:null,fastingEndAt:null,fastingMinutes:null};
  // êµ¬ë²„ì „ í˜¸í™˜
  if(s.fastingStart && !s.fastingStartAt) s.fastingStartAt = s.fastingStart;
  if(!("fastingStartAt" in s)) s.fastingStartAt = null;
  if(!("fastingEndAt" in s)) s.fastingEndAt = null;
  if(!("fastingMinutes" in s)) s.fastingMinutes = null;
  if(!s.checks || typeof s.checks!=="object") s.checks = {};
  if(typeof s.waterMl !== "number") s.waterMl = 0;
  if(typeof s.proteinG !== "number") s.proteinG = 0;
  if(!s.mode) s.mode = "base";
  return s;
}
function saveStateForKey(k, s){
  localStorage.setItem(k, JSON.stringify(s));
}

function startFasting(){
  const sess = loadFastSession();
  if(sess && sess.startAt){
    if(!confirm("ìƒˆë¡œìš´ ë‹¨ì‹ì„ ì‹œì‘í• ê¹Œ?")) return;
  }
  saveFastSession({ startAt: new Date().toISOString() });
  update();
}

function endFasting(){
  const sess = loadFastSession();
  if(!sess || !sess.startAt){
    alert("ì¢…ë£Œí•  ë‹¨ì‹ì´ ì—†ì–´. ë¨¼ì € 'â›”ì‹œì‘'ì„ ëˆŒëŸ¬ì¤˜.");
    return;
  }
  const start = new Date(sess.startAt);
  const end = new Date();
  const mins = (end - start) / (60*1000);

  // âœ… ì¢…ë£Œí•œ 'ì˜¤ëŠ˜'ì— ê¸°ë¡ìœ¼ë¡œ ì €ì¥ (ë‚ ì§œ ë„˜ì–´ë„ OK)
  const k = getLocalDateKey(new Date()); // ì§€ê¸ˆ ì‹œì  ê¸°ì¤€
  const s = getStateForKey(k);
  s.fastingStartAt = sess.startAt;
  s.fastingEndAt   = end.toISOString();
  s.fastingMinutes = Math.max(0, Math.round(mins));
  saveStateForKey(k, s);

  // ì§„í–‰ ì„¸ì…˜ ì¢…ë£Œ
  clearFastSession();

  // í™”ë©´ì´ ì˜¤ëŠ˜ì´ë“  ê³¼ê±° í¸ì§‘ì´ë“ , "ì˜¤ëŠ˜ ê¸°ë¡"ì´ ì €ì¥ëœ ë’¤ í‘œì‹œ ê°±ì‹ 
  if(activeDateKey === todayKey){
    state = s;
  }
  update();
}

function cancelFasting(){
  const sess = loadFastSession();
  if(!sess || !sess.startAt){
    alert("ì·¨ì†Œí•  ì§„í–‰ ì¤‘ ë‹¨ì‹ì´ ì—†ì–´.");
    return;
  }

  if(!confirm("ì§„í–‰ ì¤‘ì¸ ë‹¨ì‹ë§Œ ì·¨ì†Œí• ê¹Œ?")) return;

  clearFastSession();
  update();
}

function deleteFastingRecord(){
  if(!state.fastingEndAt){
    alert("ì‚­ì œí•  ë‹¨ì‹ ê¸°ë¡ì´ ì—†ì–´.");
    return;
  }

  const start = new Date(state.fastingStartAt);
  const end   = new Date(state.fastingEndAt);
  
  const dateStr =
    `${start.getFullYear()}.` +
    `${String(start.getMonth()+1).padStart(2,"0")}.` +
    `${String(start.getDate()).padStart(2,"0")} ` +
    `${fmtHM(start)}â€“${fmtHM(end)}`;
  
  if(!confirm(`${dateStr}\n\nì´ ë‚ ì§œì˜ ë‹¨ì‹ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œ?`)) return;


  state.fastingStartAt = null;
  state.fastingEndAt   = null;
  state.fastingMinutes = null;

  // êµ¬ë²„ì „ í•„ë“œ ì •ë¦¬ (ìˆì„ ê²½ìš°ë§Œ)
  if("fastingStart" in state) state.fastingStart = null;

  saveStateForKey(activeDateKey, state);
  update();
}


function renderFasting(){
  const delBtn = document.getElementById("deleteFastingBtn");
  const el = document.getElementById("fastText");
  if(!el) return;

  const sess = loadFastSession();

  // 1) ì§„í–‰ ì¤‘ ì„¸ì…˜ì´ ìˆìœ¼ë©´: ë‚ ì§œ ë„˜ì–´ë„ ê³„ì† í‘œì‹œ
  if(sess && sess.startAt){
    const start = new Date(sess.startAt);
    const end = new Date(start.getTime() + FAST_HOURS*60*60*1000);
    const now = new Date();
  
    const startHM = fmtHM(start);
    const endHM   = fmtHM(end);
  
    if(now >= end){
      el.innerHTML = `ğŸ ${FAST_HOURS}ì‹œê°„ ë‹¨ì‹ (${startHM}-<span class="good">${endHM}</span> / 00:00)`;
    }else{
      const mm = Math.floor((end - now)/60000);
      const rh = Math.floor(mm/60);
      const rm = mm % 60;
  
      el.innerHTML = `ğŸ ${FAST_HOURS}ì‹œê°„ ë‹¨ì‹ (${startHM}-<span class="need">${endHM}</span> / ë‚¨ì€ ${String(rh).padStart(2,"0")}:${String(rm).padStart(2,"0")})`;
    }
    return;
  }

  // 2) ì§„í–‰ ì¤‘ì´ ì•„ë‹ˆë©´: ì˜¤ëŠ˜(ì„ íƒëœ ë‚ ì§œ)ì˜ ì™„ë£Œ ê¸°ë¡ í‘œì‹œ
  if(state.fastingEndAt && typeof state.fastingMinutes === "number"){
    const endAt = new Date(state.fastingEndAt);
    el.innerHTML = `âœ… ë‹¨ì‹ ì¢…ë£Œ <span class="good">${fmtHM(endAt)}</span> Â· ğŸ•’ ì‹¤ì œ ë‹¨ì‹ ${fmtDuration(state.fastingMinutes)}`;

    if(delBtn) delBtn.style.display = "inline-block";
    return;
  }

  // 3) ê·¸ ì™¸: ì‹œì‘ ì•ˆ í•¨
  el.innerHTML = `ğŸ ${FAST_HOURS}ì‹œê°„ ë‹¨ì‹`;
  if(delBtn) delBtn.style.display = "none";
}
  
function manualFasting(){
  const sess = loadFastSession();

  let start, end;

  // 1ï¸âƒ£ ìë™ ì„¸ì…˜ ì—†ìŒ + ì§€ê¸ˆ ë‹¨ì‹ ì¤‘ â†’ ì‹œì‘ë§Œ ì…ë ¥
  if(!sess){
    const wantStart = confirm("ì´ë¯¸ ë‹¨ì‹ ì¤‘ì´ì•¼?\n\nì·¨ì†Œ = ë‘˜ ë‹¤ ì…ë ¥\ní™•ì¸ = ì‹œì‘ë§Œ ì…ë ¥");

    if(wantStart){
      const startStr = prompt("ì‹œì‘ ì‹œê° (HH:MM)");
      if(!startStr) return;

      const [sh, sm] = startStr.split(":").map(Number);
      if(isNaN(sh)||isNaN(sm)){ alert("HH:MM í˜•ì‹"); return; }

      const base = new Date();
      start = new Date(base);
      start.setHours(sh, sm, 0, 0);

      if(start > base) start.setDate(start.getDate()-1);

      saveFastSession({ startAt: start.toISOString() });
      update();
      return;
    }
  }

  // 2ï¸âƒ£ ì´ë¯¸ ì‹œì‘ ë²„íŠ¼ ëˆŒëŸ¬ë‘” ê²½ìš° â†’ ì¢…ë£Œë§Œ ì…ë ¥
  if(sess && sess.startAt){
    start = new Date(sess.startAt);

    const endStr = prompt("ì¢…ë£Œ ì‹œê° (HH:MM)");
    if(!endStr) return;

    const [eh, em] = endStr.split(":").map(Number);
    if(isNaN(eh)||isNaN(em)){ alert("HH:MM í˜•ì‹"); return; }

    end = new Date(start);
    end.setHours(eh, em, 0, 0);
    if(end <= start) end.setDate(end.getDate()+1);
  }

  // 3ï¸âƒ£ ë‘˜ ë‹¤ ì…ë ¥
  else{
    const startStr = prompt("ì‹œì‘ ì‹œê° (HH:MM)");
    if(!startStr) return;

    const endStr = prompt("ì¢…ë£Œ ì‹œê° (HH:MM)");
    if(!endStr) return;

    const [sh, sm] = startStr.split(":").map(Number);
    const [eh, em] = endStr.split(":").map(Number);

    if(isNaN(sh)||isNaN(sm)||isNaN(eh)||isNaN(em)){
      alert("HH:MM í˜•ì‹"); return;
    }

    const base = new Date(activeDateKey);
    start = new Date(base); start.setHours(sh, sm, 0, 0);
    end   = new Date(base); end.setHours(eh, em, 0, 0);
    if(end <= start) end.setDate(end.getDate()+1);
  }

  const mins = Math.round((end - start)/60000);

  state.fastingStartAt = start.toISOString();
  state.fastingEndAt   = end.toISOString();
  state.fastingMinutes = mins;

  save();
  clearFastSession();
  update();
}


  
/* =========================
   ìˆ˜ë©´ íŠ¸ë˜í‚¹
========================= */

function startSleep(){
  const sess = loadSleepSession();
  if(sess && sess.startAt){
    if(!confirm("ë„Œ ì ìê³  ìˆì–´. ìƒˆë¡œ ì‹œì‘í• ê¹Œ?")) return;
  }
  saveSleepSession({ startAt: new Date().toISOString() });
  update();
}

function endSleep(){
  const sess = loadSleepSession();
  if(!sess || !sess.startAt){
    alert("ë„Œ ì ìê³  ìˆì§€ ì•Šì•„.");
    return;
  }

  const start = new Date(sess.startAt);
  const end   = new Date();
  const mins  = Math.max(0, Math.round((end - start) / 60000));

  // âœ… ê¸°ìƒ ì‹œì  ë‚ ì§œì— ì €ì¥
  const k = getLocalDateKey(end);
  const s = getStateForKey(k);

  s.sleepStartAt = sess.startAt;
  s.sleepEndAt   = end.toISOString();
  s.sleepMinutes = mins;

  saveStateForKey(k, s);
  clearSleepSession();

  if(activeDateKey === k) state = s;
  update();
}

function cancelSleep(){
  if(!confirm("ì§„í–‰ ì¤‘ì¸ ìˆ˜ë©´ ê¸°ë¡ì„ ì·¨ì†Œí• ê¹Œ?")) return;
  clearSleepSession();
  update();
}

function deleteSleepRecord(){
  if(!state.sleepEndAt){
    alert("ì‚­ì œí•  ìˆ˜ë©´ ê¸°ë¡ì´ ì—†ì–´.");
    return;
  }

  const start = new Date(state.sleepStartAt);
  const end   = new Date(state.sleepEndAt);

  const dateStr =
    `${start.getFullYear()}.` +
    `${String(start.getMonth()+1).padStart(2,"0")}.` +
    `${String(start.getDate()).padStart(2,"0")} ` +
    `${fmtHM(start)}â€“${fmtHM(end)}`;

  if(!confirm(`${dateStr}\n\nì´ ë‚ ì§œì˜ ìˆ˜ë©´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œ?`)) return;

  state.sleepStartAt = null;
  state.sleepEndAt   = null;
  state.sleepMinutes = null;

  save();
  update();
}

  
function renderSleep(){
  const el = document.getElementById("sleepText");
  if(!el) return;

  const delBtn = document.getElementById("deleteSleepBtn");
  const sess = loadSleepSession();

  // 1) ì·¨ì¹¨ ì¤‘
  if(sess && sess.startAt){
    const start = new Date(sess.startAt);
    el.innerHTML = `ğŸ’¤ ê¿€ì  ì¤‘ (${fmtHM(start)})`;
    if(delBtn) delBtn.style.display = "none";
    return;
  }

  // 2) ê¸°ìƒ ì™„ë£Œ ê¸°ë¡ âœ… (ì—¬ê¸°ê°€ í•µì‹¬)
  if(state.sleepEndAt && typeof state.sleepMinutes === "number"){
    const endAt = new Date(state.sleepEndAt);
    const h = Math.floor(state.sleepMinutes / 60);
    const m = state.sleepMinutes % 60;

    el.innerHTML =
      `â˜€ï¸ ê¸°ìƒ <span class="good">${fmtHM(endAt)}</span> Â· ğŸ•’ ìˆ˜ë©´ ì‹œê°„ ${h}ì‹œê°„ ${m}ë¶„`;

    if(delBtn) delBtn.style.display = "inline-block";
    return;
  }

  // 3) ê¸°ë¡ ì—†ìŒ
  el.innerHTML = "ğŸ’š í™œë™ ì¤‘";
  if(delBtn) delBtn.style.display = "none";
}


function manualSleep(){
  const sess = loadSleepSession();

  let start, end;

  // 1ï¸âƒ£ ìë™ ì„¸ì…˜ ì—†ìŒ + ì§€ê¸ˆ ìê³  ìˆìŒ â†’ ì‹œì‘ë§Œ ì…ë ¥
  if(!sess){
    const wantStart = confirm("ìˆ˜ë©´ ê¸°ë¡ í• ë˜?\n\nì·¨ì†Œ = ë‘˜ ë‹¤ ì…ë ¥\ní™•ì¸ = ì‹œì‘ë§Œ ì…ë ¥");

    if(wantStart){
      const startStr = prompt("ì·¨ì¹¨ ì‹œê° (HH:MM)");
      if(!startStr) return;

      const [sh, sm] = startStr.split(":").map(Number);
      if(isNaN(sh)||isNaN(sm)){ alert("HH:MM í˜•ì‹"); return; }

      const base = new Date();
      start = new Date(base);
      start.setHours(sh, sm, 0, 0);
      if(start > base) start.setDate(start.getDate()-1);

      saveSleepSession({ startAt: start.toISOString() });
      update();
      return;
    }
  }

  // 2ï¸âƒ£ ì´ë¯¸ ì·¨ì¹¨ ë²„íŠ¼ ëˆŒëŸ¬ë‘” ê²½ìš° â†’ ê¸°ìƒë§Œ ì…ë ¥
  if(sess && sess.startAt){
    start = new Date(sess.startAt);

    const endStr = prompt("ê¸°ìƒ ì‹œê° (HH:MM)");
    if(!endStr) return;

    const [eh, em] = endStr.split(":").map(Number);
    if(isNaN(eh)||isNaN(em)){ alert("HH:MM í˜•ì‹"); return; }

    end = new Date(start);
    end.setHours(eh, em, 0, 0);
    if(end <= start) end.setDate(end.getDate()+1);
  }

  // 3ï¸âƒ£ ë‘˜ ë‹¤ ì…ë ¥
  else{
    const startStr = prompt("ì·¨ì¹¨ ì‹œê° (HH:MM)");
    if(!startStr) return;

    const endStr = prompt("ê¸°ìƒ ì‹œê° (HH:MM)");
    if(!endStr) return;

    const [sh, sm] = startStr.split(":").map(Number);
    const [eh, em] = endStr.split(":").map(Number);

    if(isNaN(sh)||isNaN(sm)||isNaN(eh)||isNaN(em)){
      alert("HH:MM í˜•ì‹"); return;
    }

    const base = new Date(activeDateKey);
    start = new Date(base); start.setHours(sh, sm, 0, 0);
    end   = new Date(base); end.setHours(eh, em, 0, 0);
    if(end <= start) end.setDate(end.getDate()+1);
  }

  const mins = Math.round((end - start)/60000);

  state.sleepStartAt = start.toISOString();
  state.sleepEndAt   = end.toISOString();
  state.sleepMinutes = mins;

  save();
  clearSleepSession();
  update();
}


/* =========================
   ë‹¨ë°±ì§ˆ íŠ¸ë˜í‚¹
========================= */
  
function addProtein(delta){
  const next = Math.max(0, (state.proteinG||0) + delta);
  state.proteinG = next;
  save(); update();
}
function resetProtein(){
  state.proteinG = 0;
  save(); update();
}
function renderProtein(){
  const g = state.proteinG || 0;
  const target = getProteinTarget(state.mode || "base");
  const left = Math.max(0, target - g);
  const ok = g >= target;

  const capMsg = (g > PROTEIN_SOFT_CAP)
    ? ` Â· <span class="need">ìƒí•œ ${PROTEIN_SOFT_CAP}gâ†‘</span>`
    : "";

  document.getElementById("proteinTrackText").innerHTML =
    ok
    ? `ğŸ¥© ë‹¨ë°±ì§ˆ <span class="good">${g}g</span> (âœ… ìµœì†Œ ${target}g ë‹¬ì„±${capMsg})`
    : `ğŸ¥© ë‹¨ë°±ì§ˆ <span class="need">${g}g</span> (ë‚¨ì€ ${left}g / ìµœì†Œ ${target}g${capMsg})`;

  // ì† ë¶ˆí¸ ë°©ì§€ìš© ì•„ì£¼ ì§§ì€ ì•ˆë‚´(ì²´í¬ í•­ëª© ì•„ë‹˜)
  const hintEl = document.getElementById("proteinHint");
  if(hintEl){
    hintEl.innerText = `TIP: ë‹¨ë°±ì§ˆ ë¨¹ì„ ë•Œ ë°¥/ê³¼ì¼/ê²¬ê³¼ ê°™ì´(ê¶Œì¥ ìƒí•œ ${PROTEIN_SOFT_CAP}g)`;
  }
}

/* =========================
   ë¬¼ íŠ¸ë˜í‚¹
========================= */
function addWater(delta){
  const next = Math.max(0, (state.waterMl||0) + delta);
  state.waterMl = next;
  save(); update();
}
function resetWater(){
  state.waterMl = 0;
  save(); update();
}
function renderWater(){
  const ml = state.waterMl || 0;
  const left = Math.max(0, WATER_TARGET - ml);
  const cups = Math.floor(ml / WATER_UNIT);
  const ok = ml >= WATER_TARGET;

  document.getElementById("waterText").innerHTML =
    ok
    ? `ğŸ’§ ë¬¼ <span class="good">${ml}ml</span> (âœ… ëª©í‘œ ${WATER_TARGET}ml ë‹¬ì„±)`
    : `ğŸ’§ ë¬¼ <span class="need">${ml}ml</span> (ë‚¨ì€ ${left}ml / ${cups}íšŒ)`;
}

/* =========================
   ì²´í¬ë¦¬ìŠ¤íŠ¸
========================= */

const WEEKLY_WORKOUTS = {
  0: ["ğŸª½ ë“±", "ğŸ™ ìŠ¤íŠ¸ë ˆì¹­"],     // ì¼ìš”ì¼
  1: ["ğŸ”¥ ë³µë¶€", "ğŸŒ¹ í´"],       // ì›”ìš”ì¼
  2: ["ğŸ‘ í™", "ğŸ¦µ í¼ë¡¤ëŸ¬"],     // í™”ìš”ì¼
  3: ["ğŸª½ ë“±", "ğŸŒ¹ í´"],         // ìˆ˜ìš”ì¼
  4: ["ğŸ”¥ ë³µë¶€", "ğŸ’ª í¼ë¡¤ëŸ¬"],   // ëª©ìš”ì¼
  5: ["ğŸ‘ í™", "ğŸŒ¹ í™ˆí´ë§"],     // ê¸ˆìš”ì¼
  6: ["ğŸŒ¹ í´"]                  // í† ìš”ì¼
};

function renderChecklist(){
  const box = document.getElementById("checklist");
  if(!box) return;
  box.innerHTML = "";

  let list = MODES[state.mode];
if(!Array.isArray(list) || list.length === 0){
  list = BASE_ITEMS;
}

  // ìš´ë™ í•­ëª© ì¹˜í™˜
  list = list.filter(item => item.c !== "ìš´ë™");
  list = list.concat(getWorkoutChecklistItems());

  // âœ… ì—¬ê¸°ì„œë¶€í„° êµì²´ëœ ì½”ë“œ
  let lastCategory = null;
  let categoryBox = null;

  list.forEach(item => {

    if(item.c !== lastCategory){
      categoryBox = document.createElement("div");
      categoryBox.className = "section";
      box.appendChild(categoryBox);

      const h = document.createElement("div");
      h.className = "sectionTitle";
      h.innerText = item.c;
      categoryBox.appendChild(h);

      lastCategory = item.c;
    }

    const key = `${item.c}_${item.t}`;
    const checked = !!state.checks[key];

    const label = document.createElement("label");
    label.className = "checkItem";
    label.innerHTML = `
      <input type="checkbox" ${checked ? "checked" : ""}>
      <span>${item.t}</span>
    `;

    label.querySelector("input").addEventListener("change", e => {
      state.checks[key] = e.target.checked;
      saveStateForKey(activeDateKey, state);
    });

    categoryBox.appendChild(label);
  });
}

function getWorkoutChecklistItems(){

  // ğŸ‘‰ ê¸°ë³¸ ëª¨ë“œê°€ ì•„ë‹ˆë©´ ìš´ë™ ìƒì„± ìì²´ ì•ˆ í•¨
  if(state.mode !== "base") return [];

  const day = new Date(activeDateKey).getDay();
  const workouts = WEEKLY_WORKOUTS[day] || [];

  return workouts.map(text => ({
    c: "ìš´ë™",
    t: text,
    w: 2
  }));
}


/* =========================
   ë‚ ì§œ ë¶ˆëŸ¬ì˜¤ê¸°(ê³¼ê±°ë§Œ)
========================= */
function loadDate(){
  const d = document.getElementById("datePicker").value;
  if(!d) return alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì¤˜");
  if(d > todayKey) return alert("ë¯¸ë˜ ë‚ ì§œëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ì–´.");

  activeDateKey = d;
  state = JSON.parse(localStorage.getItem(activeDateKey))
    || {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStartAt:null,fastingEndAt:null,fastingMinutes:null};
  normalizeState();

  document.getElementById("today").innerText = activeDateKey + " (ìˆ˜ì •ì¤‘)";
  document.getElementById("editHint").style.display = "block";

  render();
}

function backToToday(){
  activeDateKey = todayKey;
  state = JSON.parse(localStorage.getItem(activeDateKey))
    || {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStartAt:null,fastingEndAt:null,fastingMinutes:null};
  normalizeState();

  document.getElementById("today").innerText = todayKey;
  document.getElementById("editHint").style.display = "none";

  render();
}

/* =========================
   íŒì • ê³„ì‚°
========================= */
function verdictFromRatio(ratio){
  if(ratio>=0.55) return {key:"pass", cls:"ok", txt:"í•©ê²©"};
  if(ratio>=0.30) return {key:"mid", cls:"midb", txt:"ë³´í†µ"};
  return {key:"rest", cls:"restb", txt:"íšŒë³µ"};
}

function calcWorkoutScore(s, dateKey){
  const day = new Date(dateKey).getDay();
  const workouts = WEEKLY_WORKOUTS[day] || [];
  if(workouts.length === 0) return 0;

  let checked = 0;
  workouts.forEach(text => {
    const key = `ìš´ë™_${text}`;
    if(s.checks && s.checks[key]) checked++;
  });

  const perItem = 0.5;
  return Math.min(checked * perItem, 1);
}

function calcStats(s, dateKey){
  const mode = s.mode || "base";
  let score = 0;
  let total = 0;
  let baseWorkoutOK = true; // âœ… ìŠ¤ì½”í”„ ë¬¸ì œ í•´ê²°

  const proteinG = s.proteinG || 0;
  const waterMl  = s.waterMl  || 0;
  const sleepH   = (s.sleepMinutes || 0) / 60;
  const fastH    = (s.fastingMinutes || 0) / 60;

  if(mode === "base"){
    const list = MODES.base || BASE_ITEMS;
    list.forEach(it=>{
      if(it.w > 0){
        total += it.w;
        const key = `${it.c}_${it.t}`;
        if(s.checks && s.checks[key]) score += it.w;
      }
    });

    const workoutScore = calcWorkoutScore(s, dateKey);
    total += 2;
    score += workoutScore * 2;
    baseWorkoutOK = workoutScore > 0;

    total += 2;
    if(proteinG >= getProteinTarget(mode)) score += 2;

    total += 1;
    if(waterMl >= WATER_TARGET) score += 1;

    total += 1;
    if(sleepH >= 7 && sleepH <= 9) score += 1;

    total += 1;
    if(fastH >= 14) score += 1;
  }

  else if(mode === "hard"){
    const list = MODES[mode] || [];
    let checkedAny = false;
    list.forEach(it=>{
      const key = `${it.c}_${it.t}`;
      if(s.checks && s.checks[key]) checkedAny = true;
    });

    total += 2;
    if(checkedAny) score += 2;

    total += 1;
    if(proteinG >= getProteinTarget(mode)) score += 1;

    total += 1;
    if(waterMl >= WATER_TARGET * 0.6) score += 1;

    total += 1;
    if(sleepH >= 7 && sleepH <= 10) score += 1;

    total += 1;
    if(fastH >= 12) score += 1;
  }

  else if(mode === "travel"){
    const list = MODES.travel || [];
    let checkedAny = false;
    list.forEach(it=>{
      const key = `${it.c}_${it.t}`;
      if(s.checks && s.checks[key]) checkedAny = true;
    });

    total += 2;
    if(checkedAny) score += 2;

    total += 1;
    if(proteinG >= getProteinTarget(mode)) score += 1;

    total += 1;
    if(waterMl >= WATER_TARGET * 0.6) score += 1;
  }

  let ratio = total ? score / total : 0;

  if(mode === "base" && !baseWorkoutOK){
    ratio = Math.min(ratio, 0.54);
  }

  return { mode, score, total, ratio };
}


/* =========================
   ì—…ë°ì´íŠ¸/ì´ˆê¸°í™”
========================= */
function update(){
  renderFasting();
  renderSleep();
  renderProtein();
  renderWater();
  renderChecklist();
const st = calcStats(state, activeDateKey);
  const r=document.getElementById("result");
  const v = verdictFromRatio(st.ratio);

  if(v.key==="pass"){ r.innerText="ì™„ì „ ë¿Œë“¯ ğŸ€"; r.className="result pass"; }
  else if(v.key==="mid"){ r.innerText="ì˜í–ˆë‹¤ ğŸŒ·"; r.className="result mid"; }
  else { r.innerText="íšŒë³µí•˜ëŠ” ë‚  ğŸŒ¿"; r.className="result rest"; }
}

function resetToday(){
  if(confirm("í˜„ì¬ ì„ íƒëœ ë‚ ì§œì˜ ì²´í¬ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")){
    state = {mode:"base",checks:{},waterMl:0,proteinG:0,fastingStartAt:null,fastingEndAt:null,fastingMinutes:null};
    save(); render();
  }
}

/* =========================
   íƒ­/ìš”ì•½
========================= */
function showTab(t){

  ["tabToday","tabMeal","tabAll","tabBackup"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove("active");
  });

  if(t==="today")  tabToday.classList.add("active");
  if(t==="meal")   tabMeal.classList.add("active");
  if(t==="all")    tabAll.classList.add("active");
  if(t==="backup") tabBackup.classList.add("active");

  viewToday.classList.toggle("hide", t!=="today");
  viewMeal.classList.toggle("hide", t!=="meal");
  viewAll_v2.classList.toggle("hide", t!=="all");
  viewBackup.classList.toggle("hide", t!=="backup");

  if(t==="all") renderAll_v2();
}


/* ===== ALL: group by month + filters ===== */
const dateRe = /^\d{4}-\d{2}-\d{2}$/;

function getAllKeys(){
  const keys=[];
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(dateRe.test(k)) keys.push(k);
  }
  keys.sort((a,b)=> b.localeCompare(a));
  return keys;
}

function renderAll_v2(){
  const modeF = document.getElementById("allModeFilter_v2")?.value || "all";
  const verF  = document.getElementById("allVerdictFilter_v2")?.value || "all";

  const summary = document.getElementById("allSummary_v2");
  const container = document.getElementById("viewAll_v2");
  if(!summary || !container) return;

  // ê¸°ì¡´ ì›”ë³„ ë¦¬ìŠ¤íŠ¸ ì œê±° (ìš”ì•½/í•„í„°ëŠ” ìœ ì§€)
  container.querySelectorAll("details").forEach(el => el.remove());
  container.querySelectorAll(".emptyMsg").forEach(el => el.remove());

  const keys = getAllKeys();
  const groups = {}; // { YYYY-MM: [...] }
  let total=0, pass=0, mid=0, rest=0;

  keys.forEach(k=>{
    const s = getStateForKey(k);
    if(!s) return;

    const st = calcStats(s, k);
    const v  = verdictFromRatio(st.ratio);

    // âœ… í•„í„°ëŠ” ì—¬ê¸°ì„œ!
    if(modeF !== "all" && (st.mode || "base") !== modeF) return;
    if(verF  !== "all" && v.key !== verF) return;

    total++;
    if(v.key==="pass") pass++;
    else if(v.key==="mid") mid++;
    else rest++;

    const ym = k.slice(0,7);
    groups[ym] = groups[ym] || [];

    const protein = s.proteinG ? `${s.proteinG}g` : "-";
    const water   = s.waterMl ? `${(s.waterMl/1000).toFixed(1)}L` : "-";

    let fasting = "-";
    if(s.fastingMinutes){
      const h = Math.floor(s.fastingMinutes/60);
      const m = s.fastingMinutes % 60;
      fasting = `${h}:${String(m).padStart(2,"0")}`;
    }

    let sleep = "-";
    if(s.sleepMinutes){
      const h = Math.floor(s.sleepMinutes/60);
      const m = s.sleepMinutes % 60;
      sleep = `${h}:${String(m).padStart(2,"0")}`;
    }

    groups[ym].push({
      date:k,
      mode:st.mode,
      verdict:v,
      protein, water, fasting, sleep
    });
  });

  summary.innerText = `ì´ ${total}ì¼ Â· í•©ê²© ${pass} Â· ë³´í†µ ${mid} Â· íšŒë³µ ${rest}`;

  const months = Object.keys(groups).sort((a,b)=> b.localeCompare(a));
  if(months.length === 0){
    container.insertAdjacentHTML(
      "beforeend",
      `<div class="section emptyMsg"><div class="small">ê¸°ë¡ì´ ì—†ì–´.</div></div>`
    );
    return;
  }

  months.forEach((ym, idx)=>{
    const rows = groups[ym];

    let mp=0, mm=0, mr=0;
    rows.forEach(r=>{
      if(r.verdict.key==="pass") mp++;
      else if(r.verdict.key==="mid") mm++;
      else mr++;
    });

    const det = document.createElement("details");
    if(idx===0) det.open = true;

    det.innerHTML = `
      <summary>
        <div class="summaryRow">
          <div>${ym} <span class="small">(í•©ê²© ${mp} Â· ë³´í†µ ${mm} Â· íšŒë³µ ${mr})</span></div>
          <div class="small">ëˆŒëŸ¬ì„œ í¼ì¹˜ê¸°</div>
        </div>
      </summary>
      <div style="overflow:auto; margin-top:8px;">
        <table>
          <thead>
            <tr>
              <th>ë‚ ì§œ</th>
              <th>ëª¨ë“œ</th>
              <th>íŒì •</th>
              <th>ë‹¨ë°±ì§ˆ</th>
              <th>ë¬¼</th>
              <th>ë‹¨ì‹</th>
              <th>ìˆ˜ë©´</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td>${r.date}</td>
                <td>${modeLabel(r.mode)}</td>
                <td><span class="badge ${r.verdict.cls}">${r.verdict.txt}</span></td>
                <td class="mono">${r.protein}</td>
                <td class="mono">${r.water}</td>
                <td class="mono">${r.fasting}</td>
                <td class="mono">${r.sleep}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `;
    container.appendChild(det);
  });
}

document.getElementById("allModeFilter_v2").onchange = renderAll_v2;
document.getElementById("allVerdictFilter_v2").onchange = renderAll_v2;

/* =========================
   ë°±ì—… / ë³µì›
========================= */

function exportBackup(){
  const data = JSON.stringify(localStorage);
  navigator.clipboard.writeText(data)
    .then(()=> alert("ë°±ì—… ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨"))
    .catch(()=> alert("ë³µì‚¬ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì¤˜."));
}

function importBackup(){
  const input = document.getElementById("backupInput").value.trim();
  if(!input) return alert("ë³µì›í•  ë°ì´í„°ê°€ ì—†ì–´.");

  if(!confirm("âš ï¸ ê¸°ì¡´ ëª¨ë“  ê¸°ë¡ì„ ë®ì–´ì“¸ ê±°ì•¼.\nì •ë§ ë³µì›í• ê¹Œ?")) return;
  if(!confirm("âš ï¸ ë˜ëŒë¦´ ìˆ˜ ì—†ì–´.\në§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸í• ê²Œ.")) return;

  let data;
  try{
    data = JSON.parse(input);
  }catch(e){
    alert("JSON í˜•ì‹ì´ ì•„ë‹ˆì•¼.");
    return;
  }

  localStorage.clear();

  Object.keys(data).forEach(k=>{
    localStorage.setItem(k, data[k]);
  });

  alert("ë³µì› ì™„ë£Œ. ì•±ì„ ìƒˆë¡œê³ ì¹¨í•´ì¤˜.");
}

/* =========================
   ìë™ ë°±ì—… (ìŠ¤ëƒ…ìƒ·)
========================= */

const AUTO_BACKUP_PREFIX = "__auto_backup__";
const AUTO_BACKUP_LIMIT = 7; // ìµœê·¼ 7ê°œë§Œ ìœ ì§€

function makeAutoBackup(){
  const now = new Date();
  const key =
    AUTO_BACKUP_PREFIX +
    now.toISOString().slice(0,13).replace("T","_"); // YYYY-MM-DD_HH

  // ì´ë¯¸ ê°™ì€ í‚¤ê°€ ìˆìœ¼ë©´ ì¤‘ë³µ ì €ì¥ ì•ˆ í•¨
  if(localStorage.getItem(key)) return;

  const data = JSON.stringify(localStorage);
  localStorage.setItem(key, data);

  cleanupOldAutoBackups();
}

function cleanupOldAutoBackups(){
  const keys = [];
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k.startsWith(AUTO_BACKUP_PREFIX)){
      keys.push(k);
    }
  }

  keys.sort(); // ì˜¤ë˜ëœ ê²ƒë¶€í„°
  while(keys.length > AUTO_BACKUP_LIMIT){
    const oldKey = keys.shift();
    localStorage.removeItem(oldKey);
  }
}
function restoreLatestAutoBackup(){
  const keys = [];
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k.startsWith(AUTO_BACKUP_PREFIX)){
      keys.push(k);
    }
  }

  if(keys.length === 0){
    alert("ìë™ ë°±ì—…ì´ ì—†ì–´.");
    return;
  }

  keys.sort(); // ì‹œê°„ìˆœ
  const latestKey = keys[keys.length - 1];
  const dataStr = localStorage.getItem(latestKey);

  if(!confirm(`ê°€ì¥ ìµœê·¼ ìë™ ë°±ì—…ìœ¼ë¡œ ë³µì›í• ê¹Œ?\n(${latestKey})`)) return;
  if(!confirm("âš ï¸ í˜„ì¬ ê¸°ë¡ì€ ì „ë¶€ ë®ì–´ì¨.\nì •ë§ ì§„í–‰í• ê¹Œ?")) return;

  let data;
  try{
    data = JSON.parse(dataStr);
  }catch(e){
    alert("ë°±ì—… ë°ì´í„°ê°€ ì†ìƒëì–´.");
    return;
  }

  localStorage.clear();
  Object.keys(data).forEach(k=>{
    localStorage.setItem(k, data[k]);
  });

  alert("ë³µì› ì™„ë£Œ. ì•±ì„ ìƒˆë¡œê³ ì¹¨í•´ì¤˜.");
}

  
makeAutoBackup();

  
/* =========================
   init + ë‹¨ì‹ í…ìŠ¤íŠ¸ ì£¼ê¸° ê°±ì‹ 
========================= */
render();
setInterval(()=>{ renderFasting(); }, 60*1000);

// PWA
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{ navigator.serviceWorker.register("./sw.js").catch(()=>{}); });
}
</script>

</body>
</html>



