<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸˆë£¨í‹´ ì²´í¬</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#222222">

<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f6f6f6;margin:0;padding:14px;color:#222}
h1{text-align:center;margin:6px 0}
.small{font-size:13px;color:#666}
.tabs,.modes{display:flex;gap:8px;margin:12px 0}
.tab,.mode{flex:1;padding:10px;border-radius:12px;border:none;background:#e6e6e6;font-size:14px}
.tab.active,.mode.on{background:#cfcfcf;font-weight:700}
.section{background:#fff;border-radius:14px;padding:12px;margin-bottom:10px}
.section h2{margin:0 0 8px;font-size:16px}
label{display:flex;align-items:center;gap:8px;padding:6px 0}
input[type=checkbox]{width:18px;height:18px}
.result{text-align:center;font-size:20px;font-weight:800;margin:14px 0}
.pass{color:#2e7d32}.mid{color:#f9a825}.rest{color:#c62828}
.btn{width:100%;padding:10px;border-radius:12px;border:none;background:#e6e6e6;font-size:14px}
.btn:active{background:#cfcfcf}
.hide{display:none}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eee;font-size:13px}
th{text-align:left;color:#666}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
.ok{background:#e7f6ea;color:#2e7d32}
.midb{background:#fff4d6;color:#f9a825}
.restb{background:#fde7e7;color:#c62828}
input[type=number]{width:130px;padding:6px;border-radius:8px;border:1px solid #ccc}

.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,.textin{
  padding:8px 10px;border-radius:10px;border:1px solid #ddd;background:#fff;font-size:14px;
}
.textin{min-width:160px}
details{background:#fff;border-radius:14px;padding:10px 12px;margin-bottom:10px}
details > summary{cursor:pointer;font-weight:800;list-style:none}
details > summary::-webkit-details-marker{display:none}
.summaryRow{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
.mono{font-variant-numeric:tabular-nums}

/* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼/í‘œ ê¸€ì ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
.tab, .mode { white-space: nowrap; }

/* í‘œ(ì£¼ê°„ìš”ì•½/ì „ì²´ê¸°ë¡) ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
#viewWeek th, #viewWeek td,
#viewAll  th, #viewAll  td{
  white-space: nowrap;
}

/* ê°€ë¡œê°€ ë¶€ì¡±í•˜ë©´ ìŠ¤í¬ë¡¤ë¡œ ë³´ê²Œ(ì´ë¯¸ overflow:auto ìˆì§€ë§Œ ì•ˆì „ì¥ì¹˜) */
#viewWeek .section, #viewAll .section { overflow-x: auto; }

@media (max-width: 420px){
  .tab, .mode { font-size: 13px; padding: 9px; }
}

.bonusTag{
  margin-left: 8px;
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 999px;
  background: #f1f1f1;
  color: #777;
  font-weight: 700;
}

</style>
</head>

<body>

<h1>ğŸˆë£¨í‹´ ì²´í¬</h1>
<div class="small" style="text-align:center" id="today"></div>

<!-- TABS -->
<div class="tabs">
  <button class="tab active" id="tabToday" onclick="showTab('today')">â™¥ï¸ì˜¤ëŠ˜</button>
  <button class="tab" id="tabWeek" onclick="showTab('week')">ğŸ““ì£¼ê°„ ìš”ì•½</button>
  <button class="tab" id="tabAll" onclick="showTab('all')">ğŸ“šì „ì²´ ê¸°ë¡</button>
</div>

<!-- MODES -->
<div class="modes">
  <button class="mode" id="mHard" onclick="setMode('hard')">ğŸ˜ªí˜ë“  ë‚ </button>
  <button class="mode" id="mCycle" onclick="setMode('cycle')">ğŸ©¸ìƒë¦¬ì£¼ê¸°</button>
  <button class="mode" id="mTravel" onclick="setMode('travel')">âœˆï¸ì—¬í–‰/ì´íƒˆ</button>
</div>

<!-- TODAY -->
<div id="viewToday">
  <div class="section">
    <div class="small">ğŸ¯ ëª©í‘œ ì¹¼ë¡œë¦¬: 1,450 ~ 1,650 kcal</div>
    <div style="margin-top:6px">
      ì˜¤ëŠ˜ ì„­ì·¨ kcal:
      <input type="number" id="kcalInput" placeholder="ì…ë ¥">
    </div>
    <div class="small" id="proteinText" style="margin-top:6px"></div>
  </div>

  <div id="checklist"></div>

  <div class="result" id="result">ì²´í¬ ì‹œì‘</div>

  <button class="btn" onclick="resetToday()">ì˜¤ëŠ˜ ì²´í¬ ì´ˆê¸°í™”</button>
</div>

<!-- WEEK -->
<div id="viewWeek" class="hide">
  <div class="section">
    <h2>ìµœê·¼ 7ì¼ ìš”ì•½</h2>
    <div class="small" id="weekSummary"></div>
  </div>
  <div class="section" style="overflow:auto">
    <table>
      <thead>
        <tr>
          <th>ë‚ ì§œ</th><th>ëª¨ë“œ</th><th>ì ìˆ˜</th><th>íŒì •</th><th>ë‹¨ë°±ì§ˆ</th><th>kcal</th>
        </tr>
      </thead>
      <tbody id="weekTable"></tbody>
    </table>
  </div>
</div>

<!-- ALL -->
<div id="viewAll" class="hide">
  <div class="section">
    <h2>ì „ì²´ ê¸°ë¡</h2>
    <div class="small" id="allSummary"></div>
    <div style="margin-top:10px" class="controls">
      <select id="allModeFilter">
        <option value="all">ëª¨ë“œ: ì „ì²´</option>
        <option value="base">ê¸°ë³¸</option>
        <option value="cycle">ğŸ©¸ìƒë¦¬ì£¼ê¸°</option>
        <option value="hard">ğŸ˜ªí˜ë“  ë‚ </option>
        <option value="travel">âœˆï¸ì—¬í–‰/ì´íƒˆ</option>
      </select>

      <select id="allVerdictFilter">
        <option value="all">íŒì •: ì „ì²´</option>
        <option value="pass">í•©ê²©</option>
        <option value="mid">ë³´í†µ</option>
        <option value="rest">íšŒë³µ</option>
      </select>

      <input id="allTextFilter" class="textin" placeholder="ê²€ìƒ‰(ë‚ ì§œ/ë©”ëª¨: kcal ë“±)" />
      <button class="btn" style="width:auto;padding:9px 12px" onclick="resetAllFilters()">í•„í„° ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div id="allGroups"></div>
</div>

<script>
const todayKey = new Date().toISOString().slice(0,10);
document.getElementById("today").innerText = todayKey;

const MIN_PROTEIN = 58;
const PROTEIN_UNIT = 15;

const BASE_ITEMS = [
  {c:"í•˜ë£¨",t:"ğŸ’§ ë¬¼ 2L ì´ìƒ",w:1},
  {c:"í•˜ë£¨",t:"â›” 14ì‹œê°„ ë‹¨ì‹",w:1},

  {c:"ì•„ì¹¨",t:"ğŸŒ 10ì‹œ ì „ ê¸°ìƒ",w:1},
  {c:"ì•„ì¹¨",t:"ğŸª¥ ì–‘ì¹˜ + í™˜ê¸° + ë¬¼",w:1},
  {c:"ì•„ì¹¨",t:"ğŸ’Š ì˜ì–‘ì œ",w:1},
  {c:"ì•„ì¹¨",t:"ğŸ‹ ë ˆëª¬ë¬¼ ì„¸íŠ¸",w:1},
  {c:"ì•„ì¹¨",t:"ğŸ¥š ë‹¨ë°±ì§ˆ ì„­ì·¨",w:2,p:1},

  {c:"ì ì‹¬",t:"ğŸ¥© ë‹¨ë°±ì§ˆ ì„­ì·¨",w:2,p:1},
  {c:"ì ì‹¬",t:"ğŸš¶ ì‹í›„ ê±·ê¸° 10ë¶„",w:2},
  {c:"ì ì‹¬",t:"ğŸ’Š ì˜ì–‘ì œ",w:1},

  {c:"ì˜¤í›„",t:"ğŸ§€ ë‹¨ë°±ì§ˆ ì„­ì·¨",w:2,p:1},

  {c:"ì €ë…",t:"ğŸ— ë‹¨ë°±ì§ˆ ì„­ì·¨",w:2,p:1},
  {c:"ì €ë…",t:"ğŸš¶ ì‹í›„ ê±·ê¸° 10ë¶„",w:2},

  {c:"ìš´ë™",t:"ğŸª í´ ë˜ëŠ” 5ë¶„ ì „ì‹ ìš´ë™",w:2},
  {c:"ìš´ë™",t:"ğŸ”¥ ë³µë¶€",w:0},
  {c:"ìš´ë™",t:"ğŸ’ª ì–´ê¹¨",w:0},
  {c:"ìš´ë™",t:"ğŸª½ ë“±",w:0},
  {c:"ìš´ë™",t:"ğŸ‘ í™",w:0},
];

const MODES = {
  base: BASE_ITEMS,
  hard: [
    {c:"í•µì‹¬",t:"ğŸ¥¤ ë‹¨ë°±ì§ˆ 1íšŒ",w:2,p:1},
    {c:"í•µì‹¬",t:"ğŸ’§ ë¬¼ 1ì»µ",w:1},
    {c:"í•µì‹¬",t:"ğŸ§˜ 5ë¶„ ì „ì‹  ë˜ëŠ” ìŠ¤íŠ¸ë ˆì¹­",w:2},
  ],
  cycle: [
    {c:"í•˜ë£¨",t:"ğŸ’§ ë¬¼ ì¶©ë¶„íˆ",w:1},
    {c:"í•˜ë£¨",t:"ğŸ¥š ë‹¨ë°±ì§ˆ ì„­ì·¨",w:2,p:1},
    {c:"í•˜ë£¨",t:"ğŸ¥š ë‹¨ë°±ì§ˆ ì„­ì·¨ (ì¶”ê°€)",w:2,p:1},
    {c:"í•˜ë£¨",t:"ğŸš¶ ì‹í›„ ê±·ê¸° 10ë¶„ ë˜ëŠ” ê°€ë²¼ìš´ ì›€ì§ì„",w:2},
    {c:"í•˜ë£¨",t:"ğŸ§˜ 5ë¶„ ì „ì‹  ë˜ëŠ” ìŠ¤íŠ¸ë ˆì¹­",w:2},
    {c:"í•˜ë£¨",t:"ğŸ“ ê¸°ë¡(ëŒ€ì¶©ì´ë¼ë„)",w:1},
  ],
  travel: [
    {c:"ì—¬í–‰",t:"ğŸ¥¤ ë‹¨ë°±ì§ˆ 1íšŒ",w:2,p:1},
    {c:"ì—¬í–‰",t:"ğŸš¶ ê±·ê¸° 10ë¶„",w:2},
    {c:"ì—¬í–‰",t:"ğŸ“ ê¸°ë¡ ê°€ëŠ¥í•˜ë©´",w:1},
  ]
};

const modeLabel = (m) => {
  if(m==="hard") return "ğŸ˜ªí˜ë“  ë‚ ";
  if(m==="cycle") return "ğŸ©¸ìƒë¦¬ì£¼ê¸°";
  if(m==="travel") return "âœˆï¸ì—¬í–‰/ì´íƒˆ";
  return "ê¸°ë³¸";
};

let state = JSON.parse(localStorage.getItem(todayKey))
  || {mode:"base",checks:{},kcal:""};

document.getElementById("kcalInput").value = state.kcal || "";

function save(){ localStorage.setItem(todayKey, JSON.stringify(state)); }

function setMode(m){
  state.mode = (state.mode===m) ? "base" : m;
  save(); render();
}

function render(){
  ["mHard","mCycle","mTravel"].forEach(id=>document.getElementById(id).classList.remove("on"));
  if(state.mode==="hard") mHard.classList.add("on");
  if(state.mode==="cycle") mCycle.classList.add("on");
  if(state.mode==="travel") mTravel.classList.add("on");

  const items = MODES[state.mode];
  const wrap = document.getElementById("checklist");
  wrap.innerHTML="";
  let cur="";

  items.forEach((it,i)=>{
    if(it.c!==cur){
      cur=it.c;
      const s=document.createElement("div");
      s.className="section";
      s.innerHTML=`<h2>${cur}</h2>`;
      wrap.appendChild(s);
    }
    const id = state.mode + "_" + i;
    const lbl=document.createElement("label");
    const bonus = (it.w===0) ? `<span class="bonusTag">BONUS</span>` : "";
    lbl.innerHTML = `<input type="checkbox" ${state.checks[id]?"checked":""}> ${it.t}${bonus}`;
    lbl.querySelector("input").onchange = e => {
      state.checks[id] = e.target.checked;
      save(); update();
    };
    wrap.lastChild.appendChild(lbl);
  });

  update();
}

function calcStats(s){
  const mode = s.mode || "base";
  const items = MODES[mode] || MODES.base;
  let score=0,total=0,protein=0;

  items.forEach((it,i)=>{
    const id = mode + "_" + i;
    if(it.w>0){ total += it.w; if(s.checks && s.checks[id]) score += it.w; }
    if(it.p && s.checks && s.checks[id]) protein += PROTEIN_UNIT;
  });

  const ratio = total ? (score/total) : 0;
  return { mode, score, total, ratio, protein, kcal: (s.kcal||"") };
}

function verdictFromRatio(ratio){
  if(ratio>=0.6) return {key:"pass", cls:"ok", txt:"í•©ê²©"};
  if(ratio>=0.3) return {key:"mid", cls:"midb", txt:"ë³´í†µ"};
  return {key:"rest", cls:"restb", txt:"íšŒë³µ"};
}

function update(){
  const st = calcStats(state);
  document.getElementById("proteinText").innerText =
    `ğŸ¥© ë‹¨ë°±ì§ˆ ${st.protein}g / ìµœì†Œ ${MIN_PROTEIN}g`;

  const r=document.getElementById("result");
  const v = verdictFromRatio(st.ratio);
  if(v.key==="pass"){ r.innerText="ì˜¤ëŠ˜ í•©ê²© âœ…"; r.className="result pass"; }
  else if(v.key==="mid"){ r.innerText="ë³´í†µ ğŸ™‚"; r.className="result mid"; }
  else { r.innerText="íšŒë³µ ë°ì´ ğŸŒ±"; r.className="result rest"; }
}

function resetToday(){
  if(confirm("ì˜¤ëŠ˜ ì²´í¬ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")){
    state = {mode:"base",checks:{},kcal:""};
    save(); render();
  }
}

function showTab(t){
  tabToday.classList.toggle("active", t==="today");
  tabWeek.classList.toggle("active", t==="week");
  tabAll.classList.toggle("active", t==="all");

  viewToday.classList.toggle("hide", t!=="today");
  viewWeek.classList.toggle("hide", t!=="week");
  viewAll.classList.toggle("hide", t!=="all");

  if(t==="week") renderWeek();
  if(t==="all") renderAll();
}

function renderWeek(){
  const body=document.getElementById("weekTable");
  body.innerHTML="";
  let pass=0, mid=0, rest=0;

  for(let i=6;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    const k=d.toISOString().slice(0,10);
    const s=JSON.parse(localStorage.getItem(k)||"null");
    if(!s || !s.checks) continue;

    const st = calcStats(s);
    const v = verdictFromRatio(st.ratio);
    if(v.key==="pass") pass++;
    else if(v.key==="mid") mid++;
    else rest++;

    body.innerHTML += `
      <tr>
        <td>${k}</td>
        <td>${modeLabel(st.mode)}</td>
        <td class="mono">${st.score}/${st.total}</td>
        <td><span class="badge ${v.cls}">${v.txt}</span></td>
        <td class="mono">${st.protein}g</td>
        <td class="mono">${st.kcal}</td>
      </tr>`;
  }

  document.getElementById("weekSummary").innerText =
    `í•©ê²© ${pass}ì¼ Â· ë³´í†µ ${mid}ì¼ Â· íšŒë³µ ${rest}ì¼`;
}

/* ===== ALL: group by month + filters ===== */
const dateRe = /^\d{4}-\d{2}-\d{2}$/;

function getAllKeys(){
  const keys=[];
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(dateRe.test(k)) keys.push(k);
  }
  keys.sort((a,b)=> b.localeCompare(a)); // newest first
  return keys;
}

function resetAllFilters(){
  document.getElementById("allModeFilter").value="all";
  document.getElementById("allVerdictFilter").value="all";
  document.getElementById("allTextFilter").value="";
  renderAll();
}

function renderAll(){
  const modeF = document.getElementById("allModeFilter").value;
  const verF  = document.getElementById("allVerdictFilter").value;
  const txtF  = document.getElementById("allTextFilter").value.trim().toLowerCase();

  const keys = getAllKeys();

  // group { "YYYY-MM": [rows...] }
  const groups = {};
  let totalDays=0, pass=0, mid=0, rest=0;

  keys.forEach(k=>{
    const s = JSON.parse(localStorage.getItem(k)||"null");
    if(!s || !s.checks) return;

    const st = calcStats(s);
    const v  = verdictFromRatio(st.ratio);

    // filters
    if(modeF!=="all" && (st.mode||"base") !== modeF) return;
    if(verF!=="all" && v.key !== verF) return;
    if(txtF){
      const hay = `${k} ${modeLabel(st.mode)} ${st.kcal} ${v.txt} ${st.protein}`.toLowerCase();
      if(!hay.includes(txtF)) return;
    }

    totalDays++;
    if(v.key==="pass") pass++;
    else if(v.key==="mid") mid++;
    else rest++;

    const ym = k.slice(0,7);
    groups[ym] = groups[ym] || [];
    groups[ym].push({date:k, mode:st.mode, score:st.score, total:st.total, v, protein:st.protein, kcal:st.kcal});
  });

  document.getElementById("allSummary").innerText =
    `í•„í„° ê²°ê³¼: ${totalDays}ì¼ Â· í•©ê²© ${pass} Â· ë³´í†µ ${mid} Â· íšŒë³µ ${rest} (ì›”ë³„ë¡œ ëˆŒëŸ¬ í¼ì¹˜ê¸°)`;

  // render
  const wrap = document.getElementById("allGroups");
  wrap.innerHTML = "";

  const months = Object.keys(groups).sort((a,b)=> b.localeCompare(a)); // newest month first
  if(months.length===0){
    wrap.innerHTML = `<div class="section"><div class="small">ê¸°ë¡ì´ ì—†ê±°ë‚˜ í•„í„° ì¡°ê±´ì— ë§ëŠ” ê¸°ë¡ì´ ì—†ì–´.</div></div>`;
    return;
  }

  months.forEach((ym, idx)=>{
    const rows = groups[ym];
    // month counts
    let mp=0, mm=0, mr=0;
    rows.forEach(r=>{
      if(r.v.key==="pass") mp++;
      else if(r.v.key==="mid") mm++;
      else mr++;
    });

    const det = document.createElement("details");
    // ìµœì‹  ì›”ì€ ê¸°ë³¸ í¼ì¹¨
    if(idx===0) det.open = true;

    det.innerHTML = `
      <summary>
        <div class="summaryRow">
          <div>${ym} <span class="small">(í•©ê²© ${mp} Â· ë³´í†µ ${mm} Â· íšŒë³µ ${mr})</span></div>
          <div class="small">ëˆŒëŸ¬ì„œ í¼ì¹˜ê¸°</div>
        </div>
      </summary>
      <div style="overflow:auto; margin-top:8px;">
        <table>
          <thead>
            <tr>
              <th>ë‚ ì§œ</th><th>ëª¨ë“œ</th><th>ì ìˆ˜</th><th>íŒì •</th><th>ë‹¨ë°±ì§ˆ</th><th>kcal</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td>${r.date}</td>
                <td>${modeLabel(r.mode)}</td>
                <td class="mono">${r.score}/${r.total}</td>
                <td><span class="badge ${r.v.cls}">${r.v.txt}</span></td>
                <td class="mono">${r.protein}g</td>
                <td class="mono">${r.kcal}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `;
    wrap.appendChild(det);
  });
}

document.getElementById("allModeFilter").onchange = renderAll;
document.getElementById("allVerdictFilter").onchange = renderAll;
document.getElementById("allTextFilter").oninput = () => {
  // ì…ë ¥í•  ë•Œë§ˆë‹¤ ë„ˆë¬´ ì¦ì€ ë Œë” ë°©ì§€(ê°€ë²¼ìš´ ë””ë°”ìš´ìŠ¤)
  clearTimeout(window.__rt);
  window.__rt = setTimeout(renderAll, 120);
};

document.getElementById("kcalInput").oninput = e => {
  state.kcal = e.target.value;
  save();
};

// init
render();

// PWA
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{ navigator.serviceWorker.register("./sw.js").catch(()=>{}); });
}
</script>

</body>
</html>
